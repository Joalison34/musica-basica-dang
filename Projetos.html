<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projetos Escolares</title>
  <link rel="icon" href="https://ik.imagekit.io/seu_usuario/seu_icone.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <style>
    body { 
      font-family: 'Montserrat', sans-serif; 
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2); 
      color: #333; 
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
    header { 
      background: linear-gradient(135deg, #4CAF50, #66BB6A); 
      padding: 20px; 
      text-align: center; 
      color: white; 
      border-radius: 0 0 20px 20px; 
    }
    .container { 
      width: 90%; 
      margin: auto; 
      padding: 20px; 
      display: grid; 
      gap: 20px; 
    }
    .project { 
      background: white; 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
      transition: transform 0.3s ease; 
      position: relative; 
    }
    .project:hover { 
      transform: scale(1.02); 
    }
    .info-top div, .info-block div { 
      font-weight: bold; 
      color: #388e3c; 
      margin-bottom: 5px; 
      position: relative; 
    }
    .info-item { 
      background: #f1f8e9; 
      padding: 10px; 
      border-radius: 10px; 
      margin-bottom: 10px; 
      position: relative; 
    }
    .media-item { 
      margin: 10px; 
      max-width: 200px; 
      max-height: 160px; 
      border-radius: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
      transition: filter 0.3s ease; 
    }
    .media-item:hover { 
      filter: grayscale(50%) sepia(20%); 
    }
    .edit-panel { 
      background: #f9fbe7; 
      border-radius: 10px; 
      padding: 15px; 
      margin-top: 15px; 
    }
    .edit-panel input, .edit-panel textarea { 
      width: 100%; 
      padding: 10px; 
      border-radius: 8px; 
      margin-top: 5px; 
    }
    .edit-panel button { 
      background: #aed581; 
      color: #2e7d32; 
      font-weight: bold; 
      padding: 10px; 
      border-radius: 8px; 
      cursor: pointer; 
    }
    .remove-media-btn { 
      background: #e53935; 
      color: white; 
      border-radius: 5px; 
      padding: 5px 10px; 
      margin-left: 5px; 
      cursor: pointer; 
    }
    .editable { 
      border: 1px dashed #bbb; 
      padding: 2px; 
      border-radius: 4px; 
      position: relative; 
    }
    .editable::after {
      content: '\270E';
      position: absolute;
      top: 4px;
      right: -18px;
      color: #777;
      font-size: 14px;
      opacity: 0.6;
      transition: opacity 0.3s;
    }
    .editable:hover::after { 
      opacity: 1; 
    }
    .editing-lock { 
      color: red; 
      font-weight: bold; 
      margin-top: 10px; 
    }
    #oneko {
      width: 32px;
      height: 32px;
      position: fixed;
      pointer-events: none;
      background-image: url('https://i.imgur.com/ok5b9Sz.gif');
      image-rendering: pixelated;
      z-index: 9999;
    }
  </style>
</head>
<body>

<header>
  <h1>Projetos Escolares</h1>
  <button id="passwordsKeyBtn">PasswordsKey</button>
  <button id="logoutEditBtn" style="display:none;">Sair da Edição</button>
</header>

<div class="container" id="projectsContainer"></div>

<div id="oneko" style="display: none;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyAfJZVeKznju7J-KYTE-oSz6pRfbF6mBdQ", authDomain: "funzer.firebaseapp.com", projectId: "funzer" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const IMAGEKIT_UPLOAD_URL = "https://upload.imagekit.io/api/v1/files/upload";
const IMAGEKIT_PRIVATE_KEY = "private_K0G6BijrJQ5r+PBaDTPnw1x7hLY=";

let isEditing = false, currentProject = null;

async function checkEditingLock(projectNum) {
  const doc = await db.collection('locks').doc('projeto' + projectNum).get();
  return doc.exists ? doc.data().locked : false;
}

async function setEditingLock(projectNum, status) {
  await db.collection('locks').doc('projeto' + projectNum).set({ locked: status });
}

// Carregar estado de edição do localStorage
window.onload = function() {
  const savedEditingState = localStorage.getItem('isEditing');
  const savedProject = localStorage.getItem('currentProject');
  
  if (savedEditingState === 'true' && savedProject) {
    currentProject = savedProject;
    isEditing = true;
    document.getElementById('logoutEditBtn').style.display = 'inline-block';
    carregarProjetos();
  } else {
    carregarProjetos(); // Carregar projetos normalmente se não estiver editando
  }
};

// Função para lidar com o botão de "PasswordsKey"
document.getElementById('passwordsKeyBtn').onclick = () => {
  const senha = prompt('Digite a senha:');
  if (senha === '774488') {
    const novaSenha = prompt('Digite nova senha para um grupo:');
    const projeto = prompt('Escolha o projeto (1 a 7):');
    if (novaSenha && projeto >= 1 && projeto <= 7) {
      db.collection('senhas').add({ senha: novaSenha, projeto }).then(() => alert('Senha cadastrada!'));
    }
  } else {
    db.collection('senhas').where('senha', '==', senha).get().then(snapshot => {
      if (!snapshot.empty) {
        currentProject = snapshot.docs[0].data().projeto;
        checkEditingLock(currentProject).then(isLocked => {
          if (isLocked) {
            alert('Alguém já está editando este projeto. Por favor, tente mais tarde.');
          } else {
            setEditingLock(currentProject, true);
            isEditing = true;
            localStorage.setItem('isEditing', 'true');  // Salva o estado de edição
            localStorage.setItem('currentProject', currentProject); // Salva o projeto atual
            document.getElementById('logoutEditBtn').style.display = 'inline-block';
            carregarProjetos();
          }
        });
      } else alert('Senha inválida');
    });
  }
};

// Função de logout (sair da edição)
document.getElementById('logoutEditBtn').onclick = function() {
  if (currentProject) setEditingLock(currentProject, false);
  isEditing = false; 
  currentProject = null;
  
  // Limpar o estado no localStorage
  localStorage.removeItem('isEditing');
  localStorage.removeItem('currentProject');
  
  this.style.display = 'none';
  carregarProjetos();
};

// Função de upload para o ImageKit
async function uploadToImageKit(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('fileName', file.name);
  const response = await fetch(IMAGEKIT_UPLOAD_URL, { method: 'POST', headers: { Authorization: 'Basic ' + btoa(IMAGEKIT_PRIVATE_KEY + ':') }, body: formData });
  const data = await response.json();
  return data.url;
}

// Função para carregar projetos
function carregarProjetos() {
  const container = document.getElementById('projectsContainer');

  for (let i = 1; i <= 7; i++) {
    let projDiv = document.getElementById('projeto' + i);

    if (!projDiv) {
      projDiv = document.createElement('div');
      projDiv.id = 'projeto' + i;
      projDiv.className = 'project';
      container.appendChild(projDiv);
    }

    db.collection('projetos').doc('projeto' + i).onSnapshot(doc => {
      const data = doc.exists ? doc.data() : {};

      projDiv.innerHTML = `<h2 ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>Projeto ${i}</h2>
        <div class="info-top">
          <div>Grupo: <span ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>${data.grupo || ''}</span></div>
          <div>Classe: <span ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>${data.classe || ''}</span></div>
        </div>
        <div class="info-block">
          <div class="info-item">Resumo: <span ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>${data.resumo || ''}</span></div>
          <div class="info-item">Intencao: <span ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>${data.intencao || ''}</span></div>
          <div class="info-item">Finalidade: <span ${isEditing && Number(currentProject) === i ? 'contenteditable="true" class="editable"' : ''}>${data.finalidade || ''}</span></div>
        </div>
        <div id="media-${i}" class="sortable-media"></div>
        <div id="lock-${i}" class="editing-lock"></div>`;

      const mediaDiv = projDiv.querySelector(`#media-${i}`);
      mediaDiv.innerHTML = '';

      if (data.medias) {
        data.medias.forEach((m) => {
          const el = document.createElement(m.tipo === 'video' ? 'video' : 'img');
          el.src = m.url;
          if (m.tipo === 'video') el.controls = true;
          el.className = 'media-item';
          mediaDiv.appendChild(el);
        });
      }

      if (isEditing && Number(currentProject) === i) {
        const form = document.createElement('div');
        form.className = 'edit-panel';
        form.innerHTML = `<input type="file" id="file-${i}" multiple>
          <button onclick="salvarTudo(${i})">Salvar Tudo</button>`;
        projDiv.appendChild(form);
        new Sortable(mediaDiv, { animation: 150 });
      }
    });

    db.collection('locks').doc('projeto' + i).onSnapshot(lockDoc => {
      const lockInfo = document.getElementById('lock-' + i);
      if (lockDoc.exists && lockDoc.data().locked && !(isEditing && Number(currentProject) === i)) {
        lockInfo.innerText = 'Outro usuário está editando este projeto.';
      } else {
        lockInfo.innerText = '';
      }
    });
  }
}

async function salvarTudo(projNum) {
  const grupo = document.querySelector(`#projeto${projNum} .info-top div:nth-child(1) span`).innerText;
  const classe = document.querySelector(`#projeto${projNum} .info-top div:nth-child(2) span`).innerText;
  const resumo = document.querySelector(`#projeto${projNum} .info-block .info-item:nth-child(1) span`).innerText;
  const intencao = document.querySelector(`#projeto${projNum} .info-block .info-item:nth-child(2) span`).innerText;
  const finalidade = document.querySelector(`#projeto${projNum} .info-block .info-item:nth-child(3) span`).innerText;
  const files = document.getElementById('file-' + projNum).files;

  const ref = db.collection('projetos').doc('projeto' + projNum);
  const doc = await ref.get();
  let medias = doc.exists && doc.data().medias ? doc.data().medias : [];

  if (files.length + medias.length > 5) return alert('Limite de 5 mídias por projeto.');

  for (let f of files) {
    const url = await uploadToImageKit(f);
    medias.push({ url, tipo: f.type.startsWith('video') ? 'video' : 'image' });
  }

  await ref.set({ grupo, classe, resumo, intencao, finalidade, medias });
  alert('Informações e mídias atualizadas!');
  carregarProjetos();
}

// Lógica do gatinho (isolada em um IIFE)
(function() {
  const Cat = {
    nekoEl: null,
    nekoPosX: -16,
    nekoPosY: -16,
    mousePosX: 0,
    mousePosY: 0,
    frameCount: 0,
    idleTime: 0,
    idleAnimation: null,
    idleAnimationFrame: 0,
    nekoSpeed: 12,

    spriteSets: {
      idle: [[-3, -3]],
      alert: [[-7, -3]],
      scratchSelf: [[-5, 0], [-6, 0], [-7, 0]],
      scratchWallN: [[0, 0], [0, -1]],
      scratchWallS: [[-7, -1], [-6, -2]],
      scratchWallE: [[-2, -2], [-2, -3]],
      scratchWallW: [[-4, 0], [-4, -1]],
      tired: [[-3, -2]],
      sleeping: [[-2, 0], [-2, -1]],
      N: [[-1, -2], [-1, -3]],
      NE: [[0, -2], [0, -3]],
      E: [[-3, 0], [-3, -1]],
      SE: [[-5, -1], [-5, -2]],
      S: [[-6, -3], [-7, -2]],
      SW: [[-5, -3], [-6, -1]],
      W: [[-4, -2], [-4, -3]],
      NW: [[-1, 0], [-1, -1]],
    },

    init: function() {
      this.nekoEl = document.querySelector("#oneko");
      if (!this.nekoEl) {
        console.warn("Elemento #oneko não encontrado!");
        return;
      }
      this.nekoEl.style.display = "block";
      this.nekoEl.style.left = `${this.nekoPosX - 16}px`;
      this.nekoEl.style.top = `${this.nekoPosY - 16}px`;

      document.addEventListener('mousemove', (event) => {
        this.mousePosX = event.clientX;
        this.mousePosY = event.clientY;
      });

      window.setInterval(() => this.frame(), 100);
    },

    setSprite: function(name, frame) {
      const sprite = this.spriteSets[name][frame % this.spriteSets[name].length];
      this.nekoEl.style.backgroundPosition = `${sprite[0] * 32}px ${sprite[1] * 32}px`;
    },

    idle: function() {
      this.idleTime += 1;

      if (this.idleTime > 10 && Math.floor(Math.random() * 200) === 0 && this.idleAnimation === null) {
        const availableIdleAnimations = ["sleeping", "scratchSelf"];
        this.idleAnimation = availableIdleAnimations[Math.floor(Math.random() * availableIdleAnimations.length)];
      }

      switch (this.idleAnimation) {
        case "sleeping":
          this.setSprite("tired", 0);
          if (++this.idleAnimationFrame > 192) this.idleAnimation = null;
          break;
        case "scratchSelf":
          this.setSprite(this.idleAnimation, this.idleAnimationFrame);
          if (++this.idleAnimationFrame > 9) this.idleAnimation = null;
          break;
        default:
          this.setSprite("idle", 0);
      }
    },

    frame: function() {
      if (!this.nekoEl) return;
      this.frameCount += 1;
      const targetX = Math.min(Math.max(0, this.mousePosX), window.innerWidth);
      const targetY = Math.min(Math.max(1, this.mousePosY - 32), window.innerHeight - 1);
      const diffX = this.nekoPosX - targetX;
      const diffY = this.nekoPosY - targetY;
      const distance = Math.sqrt(diffX ** 2 + diffY ** 2);

      if (distance < this.nekoSpeed || (distance < 48 && Math.abs(diffY) < 16)) {
        this.idle();
        return;
      }

      this.idleAnimation = null;
      this.idleAnimationFrame = 0;
      const direction = (diffY / distance > 0.5 ? "N" : "") + (diffY / distance < -0.5 ? "S" : "") +
        (diffX / distance > 0.5 ? "W" : "") + (diffX / distance < -0.5 ? "E" : "");
      this.setSprite(direction, this.frameCount);

      this.nekoPosX -= (diffX / distance) * this.nekoSpeed;
      this.nekoPosY -= (diffY / distance) * this.nekoSpeed;

      this.nekoPosX = Math.min(Math.max(16, this.nekoPosX), window.innerWidth - 16);
      this.nekoPosY = Math.min(Math.max(16, this.nekoPosY), window.innerHeight - 16);

      this.nekoEl.style.left = `${this.nekoPosX - 16}px`;
      this.nekoEl.style.top = `${this.nekoPosY - 16}px`;
    }
  };

  // Iniciar o gato após o DOM carregar
  document.addEventListener('DOMContentLoaded', () => {
    try {
      Cat.init();
    } catch (e) {
      console.error("Erro ao inicializar o gato:", e);
    }
  });
})();
</script>
<footer style="text-align:center; margin-top:20px;">© 2025 Projetos Sustentáveis</footer>
</body>
</html>
