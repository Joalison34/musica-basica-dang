<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Projetos Escolares</title>
  <link rel="icon" href="https://ik.imagekit.io/seu_usuario/seu_icone.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <style>
    body { 
      font-family: 'Montserrat', sans-serif; 
      background: linear-gradient(135deg, #182848, #182848); 
      color: #000000; 
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
    header { 
      background: linear-gradient(135deg, #4CAF50, #66BB6A); 
      padding: 20px; 
      text-align: center; 
      color: black; 
      border-radius: 0 0 20px 20px; 
      position: relative;
      z-index: 1000;
    }
    .container { 
      width: 90%; 
      margin: auto; 
      padding: 20px; 
      display: grid; 
      gap: 135px; 
    }
    .filtro {
  display: flex;
  flex-direction: column; /* input e select embaixo */
  gap: 10px;
  margin-bottom: 20px;
  margin-left: 0.1px;
}

.linha-select {
  display: flex;
  flex-direction: row;   /* select e bot√£o lado a lado */
  gap: 10px;
  align-items: center;
}


    .filtro input, .filtro select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 12px;
    }
    .project { 
     width: 240px;
      background:  #006400;
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.1); 
      transition: all 0.3s ease; 
      position: relative; 
      z-index: 500;
    }

  /* ‚úÖ Modo celular (largura cheia) */
.project.mobile-mode {
  width: 100% !important;
}

    .project:hover { 
      transform: scale(1.02); 
    }
    .project.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 2000;
      transform: none;
      margin: 0;
      border-radius: 0;
      overflow-y: auto;
      padding: 30px;
      box-sizing: border-box;
    }
    .info-top div, .info-block div { 
      font-weight: bold; 
      color: #000000; 
      margin-bottom: 5px; 
      position: relative; 
    }
    .info-item { 
      background: #f1f8e9; 
      padding: 10px; 
      border-radius: 10px; 
      margin-bottom: 10px; 
      position: relative; 
    }
    .media-item { 
      margin: 10px; 
      max-width: 200px; 
      max-height: 160px; 
      border-radius: 10px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
      transition: filter 0.3s ease; 
      cursor: pointer; 
    }

  /* ‚úÖ Garante que v√≠deos e imagens tenham o mesmo tamanho na visualiza√ß√£o */
video.media-item {
  width: 200px;
  height: 160px;
  object-fit: cover; /* preenche igual imagem */
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

    .project.fullscreen .media-item {
  max-width: 100%;
  height: auto;
  object-fit: contain;
  display: block;
  margin: 10px auto;
}

    }
    .media-item:hover { 
      filter: grayscale(50%) sepia(20%); 
    }
    .media-container {
      display: inline-block;
      position: relative;
    }
    .edit-panel { 
      background: #f9fbe7; 
      border-radius: 10px; 
      padding: 15px; 
      margin-top: 15px; 
    }
    .edit-panel label {
      display: block;
      margin-bottom: 10px;
    }
    .edit-panel input, .edit-panel textarea { 
      width: 100%; 
      padding: 10px; 
      border-radius: 8px; 
      border: 1px solid #ccc;
      margin-top: 5px; 
      box-sizing: border-box;
    }
    .edit-panel button { 
      background: #aed581; 
      color: #2e7d32; 
      font-weight: bold; 
      padding: 10px; 
      border-radius: 8px; 
      cursor: pointer; 
      margin-right: 10px;
    }
    .edit-panel .cancel-btn {
      background: #e0e0e0;
      color: #333;
    }
    .edit-panel .error {
      color: red;
      font-size: 12px;
      margin-left: 10px;
    }
    .remove-media-btn { 
      background: #e53935; 
      color: white; 
      border-radius: 5px; 
      padding: 5px 10px; 
      margin-left: 5px; 
      cursor: pointer; 
    }
    .fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    .fullscreen-btn:hover {
      background: #388e3c;
    }
    .editing-lock { 
      color: #000000; 
      font-weight: bold; 
      margin-top: 10px; 
    }
    #oneko {
      width: 32px;
      height: 32px;
      position: fixed;
      pointer-events: none;
      background-image: url('https://i.imgur.com/ok5b9Sz.gif');
      image-rendering: pixelated;
      z-index: 9999;
    }
    #media-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 10000;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  opacity: 0;
  transition: opacity 0.4s ease;
}

#media-overlay.show {
  display: flex;
  opacity: 1;
}

#media-overlay .viewer {
  position: relative;
  width: 80%;
  height: 70vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

    #media-overlay .media {
  position: absolute;
  max-width: 70%;
  max-height: 75%;
  border-radius: 12px;
  opacity: 0;
  transform: scale(0.7);
  transition: all 0.5s ease;
  object-fit: contain;
}

#media-overlay .media.active {
  opacity: 1;
  transform: scale(1);
  z-index: 3;
}

#media-overlay .controls {
  margin-top: 20px;
}
#media-overlay .controls button {
  padding: 10px 20px;
  margin: 0 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  background: #00ff99;
  color: #111;
  transition: all 0.3s;
}
#media-overlay .controls button:hover {
  background: #00ffaa;
  transform: scale(1.1);
}

 .foto-perfil-img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 10px;
  border: 2px solid #00ff00; /* estilo neon */
}

    #media-overlay .foto-perfil-expandida {
  position: relative;       /* libera do absolute */
  width: 60vmin;
  height: 60vmin;
  max-width: none;          /* remove limite que trava */
  max-height: none;
  border-radius: 50%;
  object-fit: cover;        /* cobre o c√≠rculo */
  border: 4px solid #00ff00;
  display: block;
  margin: auto;
}


  #media-overlay .controls {
  margin-top: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 40px; /* espa√ßo entre os bot√µes */
}

#media-overlay .controls button {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  background: #00ff99;
  color: #111;
  transition: all 0.3s;
}

#media-overlay .controls button:hover {
  background: #00ffaa;
  transform: scale(1.1);
}

    /* üî• Infos no overlay */
 /* --- Anima√ß√£o tipo folha de livro para as infos --- */
   /* Base */
    /* üî• Infos no overlay (nova vers√£o com efeito folha mais real) */
  #media-overlay .info-overlay {
  position: absolute;
  width: 70%;
  height: 70%;
  background: #f1f8e9;
  color: #000;
  border-radius: 15px;
  padding: 30px;
  box-sizing: border-box;
  text-align: center;
  overflow-y: auto;

  opacity: 0;
  transform: rotateY(180deg);
  transform-origin: left center;
  backface-visibility: hidden;
  transition: transform 0.8s ease, opacity 0.8s ease;
}

/* P√°gina atual (em cima) */
#media-overlay .info-overlay.active {
  opacity: 1;
  transform: rotateY(0deg);
  z-index: 3;
}

/* P√°gina j√° posicionada atr√°s, esperando ser revelada */
#media-overlay .info-overlay.behind {
  opacity: 1;
  transform: rotateY(180deg);
  z-index: 1;
}

/* Anima√ß√µes de virar */
#media-overlay .info-overlay.turning-right {
  transform: rotateY(-180deg);
  transform-origin: left center;
  z-index: 2;
}

#media-overlay .info-overlay.turning-left {
  transform: rotateY(180deg);
  transform-origin: right center;
  z-index: 2;
}

#media-overlay .info-overlay h2 {
  font-size: 24px;
  margin-bottom: 15px;
  color: #006400;
}

   #media-overlay .info-overlay p {
  font-size: 18px;
  line-height: 1.4;
  color: #333; /* cor padr√£o se n√£o houver ambienta√ß√£o */
}

#media-overlay .info-overlay p span {
  color: inherit !important; /* deixa o JS sobrescrever */
}

   /* üî• Ambienta√ß√£o Personalizada */
.project {
  transition: background 0.5s ease, color 0.5s ease;
}

.project .info-item {
  transition: background 0.5s ease, color 0.5s ease;
}

.project .info-item span {
  transition: color 0.5s ease;
}

body, header {
  transition: background 0.6s ease, color 0.6s ease;
}

 /* üîä Som de fundo - estilo parecido com m√≠dias */
.audio-item {
  background: #f1f8e9;
  padding: 8px 12px;
  border-radius: 8px;
  margin-top: 8px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  font-weight: bold;
  color: #333;
}

  </style>
</head>
<body>

<header>
  <h1>Projetos Escolares</h1>
  <button id="passwordsKeyBtn" style="
  position: absolute;
  top: 15px;
  left: 15px;
  background: #006633;
  color: black;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 18px;
  cursor: pointer;
  isolation: isolate;
">
  üîê
</button>

  <button id="logoutEditBtn" style="display:none;">Sair da Edi√ß√£o</button>

   <!-- ‚úÖ Bot√£o de troca Classe A/B -->
  <button id="toggleClassBtn" style="
    position: absolute;
    top: 15px;
    right: 15px;
    background: #ffcc00;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 16px;
    cursor: pointer;">
    Classe A
  </button>
</header>

<div class="container" id="projectsContainer">
  <div class="filtro">
    <input type="text" id="filtro-projetos" placeholder="Filtrar">
    <select id="ordenar-projetos">
      <option value="numero">Ordenar por N√∫mero</option>
      <option value="grupo">Ordenar por Grupo</option>
      <option value="ultima-edicao">Ordenar por √öltima Edi√ß√£o</option>
    </select>

     <!-- Bot√£o üì± / üíª agora junto do filtro -->
  <button id="toggleDeviceBtn" style="
    background: #222;
    color: #00ff00;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 16px;
    cursor: pointer;">
    üì± / üíª
  </button>
  </div>
</div>

<div id="oneko" style="display: none;"></div>

   <div id="media-overlay">
  <div class="viewer" id="viewer"></div>
  <div class="controls">
    <button id="prev-btn" onclick="prevMedia(); prevInfo()">‚¨Ö</button>
    <button id="close-btn" onclick="closeOverlay()">‚úñ</button>
    <button id="next-btn" onclick="nextMedia(); nextInfo()">‚û°</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = { apiKey: "AIzaSyAfJZVeKznju7J-KYTE-oSz6pRfbF6mBdQ", authDomain: "funzer.firebaseapp.com", projectId: "funzer" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const IMAGEKIT_UPLOAD_URL = "https://upload.imagekit.io/api/v1/files/upload";
const IMAGEKIT_PRIVATE_KEY = "private_K0G6BijrJQ5r+PBaDTPnw1x7hLY=";

let isEditing = false, currentProject = null;

// ‚úÖ Classe atual e limites
let currentClass = "A"; 
const projectLimits = { A: 7, B: 5 };  

// ‚úÖ fun√ß√£o para pegar o nome da cole√ß√£o
function getCollectionName() {
  return currentClass === "A" ? "projetos" : "projetos2";
}

async function checkEditingLock(projectNum) {
  const doc = await db.collection('locks').doc('projeto' + projectNum).get();
  return doc.exists ? doc.data().locked : false;
}

async function setEditingLock(projectNum, status) {
  const userId = localStorage.getItem("senhaUsada");
  const userNome = localStorage.getItem("userNome");
  const isLider = localStorage.getItem("lider") === "true";

  // üîí continua salvando o estado atual no locks
  await db.collection('locks').doc('projeto' + projectNum).set({ 
    locked: status,
    userId,
    userNome,
    isLider
  });

  // üî• novo: salva log hist√≥rico (logo depois do await acima)
  await db.collection("logsEdicao").add({
    projeto: projectNum,
    userId,
    userNome,
    papel: isLider ? "l√≠der" : "membro",
    acao: status ? "iniciou edi√ß√£o" : "finalizou edi√ß√£o",
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}



// Carregar estado de edi√ß√£o do localStorage
window.onload = function() {
  const savedEditingState = localStorage.getItem('isEditing');
  const savedProject = localStorage.getItem('currentProject');
  
  if (savedEditingState === 'true' && savedProject) {
    currentProject = savedProject;
    isEditing = true;
    document.getElementById('logoutEditBtn').style.display = 'inline-block';
    carregarProjetos();
  } else {
    carregarProjetos();
  }
};

 // Alternar entre largura fixa (240px) e largura cheia (100%)
document.addEventListener("click", function(e) {
  if (e.target && e.target.id === "toggleDeviceBtn") {
    document.querySelectorAll(".project").forEach(proj => {
      proj.classList.toggle("mobile-mode");
    });
  }
});

  function mostrarBotaoMembrosSeLider() {
  if (localStorage.getItem("lider") === "true") {
    const logoutBtn = document.getElementById("logoutEditBtn");
    if (logoutBtn) {
      const membrosBtn = document.createElement("button");
      membrosBtn.innerText = "Membros";
      membrosBtn.style.display = "inline-block";
      membrosBtn.style.marginLeft = "10px";
      membrosBtn.onclick = () => window.location.href = "https://joalison34.github.io/musica-basica-dang/painel.html";
      logoutBtn.insertAdjacentElement("afterend", membrosBtn);
    }
  }
}

// Fun√ß√£o para lidar com o bot√£o de "PasswordsKey"
document.getElementById('passwordsKeyBtn').onclick = () => {
  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.background = "rgba(0,0,0,0.85)";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  // overlay.style.justifyContent = "center"; ‚ùå Remova esta linha
  overlay.style.alignItems = "flex-start"; // Alinha √† esquerda
  overlay.style.paddingLeft = "15px"; // Afasta da borda da tela
  overlay.style.zIndex = 9999;

  const caixa = document.createElement("div");
  caixa.style.background = "#1c1c1c";
  caixa.style.border = "2px solid #00FF00";
  caixa.style.borderRadius = "12px";
  caixa.style.padding = "30px";
  caixa.style.display = "flex";
  caixa.style.flexDirection = "column";
  caixa.style.alignItems = "center";
  caixa.style.width = "230px";           // ‚úÖ Largura
  caixa.style.maxHeight = "120vh";       // ‚úÖ Altura m√°xima
  caixa.style.overflowY = "auto";        // ‚úÖ Rolagem
  caixa.style.marginTop = "120px";        // ‚úÖ Agora posicionado a 75px do topo


  

  const titulo = document.createElement("h2");
  titulo.innerText = "Digite sua senha de acesso:Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ†Ôæ† C√≥digo extra:  Ôæ†Ôæ†use (chat) pra entrar no chat de bate e papo e feedbacks";
  titulo.style.color = "#00FF00";
  titulo.style.marginBottom = "20px";
  titulo.style.fontFamily = "Montserrat";

  const input = document.createElement("input");
  input.type = "password";
  input.placeholder = "Digite seu c√≥digo";
  input.style.padding = "12px 15px";
  input.style.border = "1px solid #00FF00";
  input.style.background = "#2e2e2e";
  input.style.color = "#fff";
  input.style.fontSize = "16px";
  input.style.width = "220px";

  const enviar = document.createElement("button");
  enviar.innerText = "Acessar";
  enviar.style.marginTop = "15px";
  enviar.style.padding = "10px 20px";
  enviar.style.border = "none";
  enviar.style.background = "#00FF00";
  enviar.style.color = "#000";
  enviar.style.fontWeight = "bold";
  enviar.style.cursor = "pointer";
  enviar.onclick = () => {
    const senha = input.value.trim().toLowerCase();
    document.body.removeChild(overlay);

    if (senha.toLowerCase() === 'chat') {
  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.background = "rgba(0,0,0,0.85)";
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.justifyContent = "center";
  overlay.style.alignItems = "center";
  overlay.style.zIndex = 9999;

  const msg = document.createElement("div");
  msg.innerHTML = "<h2 style='color:#fff; font-family:Montserrat;'>Escolha o chat <br><small style='color:#ccc;'>Recomendado para seu dispositivo</small></h2>";
  msg.style.textAlign = "center";
  msg.style.marginBottom = "20px";

  const btns = document.createElement("div");
  btns.style.display = "flex";
  btns.style.gap = "20px";

  const celularBtn = document.createElement("button");
  celularBtn.innerText = "Chat (Celular)";
  celularBtn.style.padding = "15px 25px";
  celularBtn.style.background = "linear-gradient(135deg, #00f0ff, #0099ff)";
  celularBtn.style.color = "#fff";
  celularBtn.style.border = "none";
  celularBtn.style.fontWeight = "bold";
  celularBtn.style.cursor = "pointer";
  celularBtn.onmouseenter = () => celularBtn.style.transform = "scale(1.1)";
  celularBtn.onmouseleave = () => celularBtn.style.transform = "scale(1)";
  celularBtn.onclick = () => {
    window.location.href = "Chat.html";
  };

  const windowsBtn = document.createElement("button");
  windowsBtn.innerText = "Chat (Windows)";
  windowsBtn.style.padding = "15px 25px";
  windowsBtn.style.background = "linear-gradient(135deg, #ff3c00, #ff0000)";
  windowsBtn.style.color = "#fff";
  windowsBtn.style.border = "none";
  windowsBtn.style.borderRadius = "12px";
  windowsBtn.style.fontWeight = "bold";
  windowsBtn.style.cursor = "pointer";
  windowsBtn.onmouseenter = () => windowsBtn.style.transform = "scale(1.1)";
  windowsBtn.onmouseleave = () => windowsBtn.style.transform = "scale(1)";
  windowsBtn.onclick = () => {
    window.location.href = "Chat.html";
  };


  btns.appendChild(celularBtn);
  btns.appendChild(windowsBtn);
  overlay.appendChild(msg);
  overlay.appendChild(btns);
  document.body.appendChild(overlay);

  return;
}


    if (senha === "774488") {
  const novaSenha = prompt("Digite nova senha para um grupo:");
  const limite = projectLimits[currentClass];   // ‚úÖ pega 7 ou 5
  const projeto = prompt(`Escolha o projeto (1 a ${limite}):`);
  if (novaSenha && projeto >= 1 && projeto <= limite) {
    const nomeLider = prompt("Digite o nome do l√≠der:");
db.collection("senhas").add({
  senha: novaSenha,
  nome: nomeLider || "Sem nome",
  projeto,
  classe: currentClass,
  lider: true
}).then(() => alert(`Senha cadastrada com l√≠der na Classe ${currentClass}!`));
  }
}
  else {
  db.collection("senhas").where("senha", "==", senha).get().then(snapshot => {
    if (!snapshot.empty) {
      const dadosSenha = snapshot.docs[0].data();

      // üö® Verifica se a classe do c√≥digo bate com a atual
      if (dadosSenha.classe !== currentClass) {
        alert(`Este c√≥digo pertence √† Classe ${dadosSenha.classe}, mas voc√™ est√° na Classe ${currentClass}.`);
        return;
      }

      currentProject = dadosSenha.projeto;

      // Salva se √© l√≠der
      localStorage.setItem("lider", dadosSenha.lider ? "true" : "false");
      localStorage.setItem("userNome", dadosSenha.nome || dadosSenha.senha);

      checkEditingLock(currentProject).then(isLocked => {
        if (isLocked) {
          alert("Algu√©m j√° est√° editando este projeto.");
          // continua permitindo edi√ß√£o se quiser
        }
        setEditingLock(currentProject, true);
        isEditing = true;
        localStorage.setItem("isEditing", "true");
        localStorage.setItem("currentProject", currentProject);
        localStorage.setItem("senhaUsada", senha);
        document.getElementById("logoutEditBtn").style.display = "inline-block";
        carregarProjetos();
        mostrarBotaoMembrosSeLider();
      });
    }
    else {
      alert("Senha inv√°lida.");
    }
  });
}
  };

  caixa.appendChild(titulo);
  caixa.appendChild(input);
  caixa.appendChild(enviar);
  overlay.appendChild(caixa);
  document.body.appendChild(overlay);
};


// Fun√ß√£o de logout (sair da edi√ß√£o)
document.getElementById('logoutEditBtn').onclick = function() {
  if (currentProject) setEditingLock(currentProject, false);
  isEditing = false; 
  currentProject = null;
  localStorage.removeItem('isEditing');
  localStorage.removeItem('currentProject');
  localStorage.removeItem('senhaUsada');
  this.style.display = 'none';
  carregarProjetos();
};

// Fun√ß√£o de upload para o ImageKit
async function uploadToImageKit(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('fileName', file.name);
  const response = await fetch(IMAGEKIT_UPLOAD_URL, { method: 'POST', headers: { Authorization: 'Basic ' + btoa(IMAGEKIT_PRIVATE_KEY + ':') }, body: formData });
  const data = await response.json();
  return data.url;
}

// Fun√ß√£o para abrir m√≠dia em tela cheia
const overlay = document.getElementById('media-overlay');
const viewer = document.getElementById('viewer');
let currentIndex = 0;
let slides = [];

// Fun√ß√£o para abrir overlay com lista de m√≠dias do projeto
function abrirMediaTelaCheia(url, tipo, listaMedias = []) {
  viewer.innerHTML = "";
  slides = [];

  listaMedias.forEach((m, i) => {
    const el = document.createElement(m.tipo === "video" ? "video" : "img");
    el.src = m.url;
    if (m.tipo === "video") el.controls = true;
    el.classList.add("media");
    if (m.url === url) {
      el.classList.add("active");
      currentIndex = i;
    }
    viewer.appendChild(el);
    slides.push(el);
  });

  // ‚úÖ Mostra setas
  document.getElementById("prev-btn").style.display = "inline-block";
  document.getElementById("next-btn").style.display = "inline-block";
  document.getElementById("close-btn").style.display = "inline-block";

  overlay.classList.add("show");
  updateClasses();
}

function abrirFotoPerfil(url) {
  viewer.innerHTML = "";
  slides = [];

  const el = document.createElement("img");
  el.src = url;
  el.classList.add("media", "active", "foto-perfil-expandida");

  viewer.appendChild(el);
  slides.push(el);

  // ‚ùå Esconde setas, deixa s√≥ o X centralizado
  document.getElementById("prev-btn").style.display = "none";
  document.getElementById("next-btn").style.display = "none";
  document.getElementById("close-btn").style.display = "inline-block";

  overlay.classList.add("show");
}

   let slidesInfo = [];
let currentInfoIndex = 0;

  function abrirInfoTelaCheia(chave, valor, projNum) {
  viewer.innerHTML = "";
  slidesInfo = [];

  const projDiv = document.getElementById("projeto" + projNum);
  const infoEls = projDiv.querySelectorAll(".info-item");

  infoEls.forEach((el, idx) => {
    const chaveTxt = el.innerText.split(":")[0];
    const valorTxt = el.querySelector("span")?.innerText || "";

    const container = document.createElement("div");
container.classList.add("info-overlay");
container.innerHTML = `
  <h2>${chaveTxt}</h2>
  <p><span>${valorTxt}</span></p>
`;

// üé® Aplica ambienta√ß√£o tamb√©m no overlay
db.collection(getCollectionName()).doc("projeto" + projNum).get().then(doc => {
  if (doc.exists && doc.data().ambientacao) {
    const amb = doc.data().ambientacao;

    if (amb.containerSecondary) {
  container.style.background = amb.containerSecondary;

  // ‚úÖ Detecta se a cor √© escura
  const bg = amb.containerSecondary.trim().toLowerCase();
  if (bg === "black" || bg === "#000" || bg === "#000000" || bg.includes("rgb(0")) {
    // Se for preto/escuro, deixa levemente transl√∫cido
    container.style.background = "rgba(0,0,0,0.85)";
    container.style.border = "1px solid #444"; // contorno leve pra destacar
  }
}

    if (amb.infoChave) {
      const h2 = container.querySelector("h2");
      if (h2) h2.style.color = amb.infoChave;
    }
    if (amb.infoValor) {
  const span = container.querySelector("p span");
  if (span) {
    span.style.color = amb.infoValor;
    span.style.setProperty("color", amb.infoValor, "important"); // for√ßa prioridade
  }
}
  }
});

    if (chaveTxt === chave && valorTxt === valor) {
      container.classList.add("active");
      currentInfoIndex = idx;
    }
    viewer.appendChild(container);
    slidesInfo.push(container);
  });

  // mostra os bot√µes
  document.getElementById("prev-btn").style.display = "inline-block";
  document.getElementById("next-btn").style.display = "inline-block";
  document.getElementById("close-btn").style.display = "inline-block";

  // ?? garante dire√ß√£o inicial para anima√ß√£o
  overlay.classList.remove("flip-forward", "flip-back");
  overlay.classList.add("flip-forward");
  overlay.classList.add("show");

  updateInfoClasses();
}

function updateInfoClasses() {
  slidesInfo.forEach((el, i) => {
    el.classList.remove("active");
    if (i === currentInfoIndex) {
      el.classList.add("active");
    }
  });
}

   function showInfo(index) {
  slidesInfo.forEach((slide, i) => {
    slide.classList.remove("active", "behind", "turning-right", "turning-left");
    if (i === index) {
      slide.classList.add("active");
    } else if (i === (index + 1) % slidesInfo.length) {
      // pr√≥xima p√°gina j√° fica atr√°s
      slide.classList.add("behind");
    }
  });
}

function nextInfo() {
  if (!slidesInfo.length) return;

  const atual = slidesInfo[currentInfoIndex];
  const proximaIndex = (currentInfoIndex + 1) % slidesInfo.length;
  const proxima = slidesInfo[proximaIndex];

  atual.classList.remove("active");
  atual.classList.add("turning-right");

  proxima.classList.remove("behind");
  proxima.classList.add("active");

  currentInfoIndex = proximaIndex;

  setTimeout(() => {
    atual.classList.remove("turning-right");
    showInfo(currentInfoIndex);
  }, 800);
}

function prevInfo() {
  if (!slidesInfo.length) return;

  const atual = slidesInfo[currentInfoIndex];
  const anteriorIndex = (currentInfoIndex - 1 + slidesInfo.length) % slidesInfo.length;
  const anterior = slidesInfo[anteriorIndex];

  atual.classList.remove("active");
  atual.classList.add("turning-left");

  anterior.classList.remove("behind");
  anterior.classList.add("active");

  currentInfoIndex = anteriorIndex;

  setTimeout(() => {
    atual.classList.remove("turning-left");
    showInfo(currentInfoIndex);
  }, 800);
}


  function closeOverlay() {
  overlay.classList.remove("show");
  setTimeout(() => {
    viewer.innerHTML = "";
    slides = [];
    slidesInfo = [];
  }, 300);
}

    // üî• Atalhos de teclado no overlay (funciona p/ m√≠dia e infos)
document.addEventListener("keydown", (e) => {
  if (!overlay.classList.contains("show")) return;

  if (e.key === "Escape") {
    closeOverlay();
  } else if (e.key === "ArrowLeft") {
    if (slidesInfo.length) prevInfo(); else prevMedia();
  } else if (e.key === "ArrowRight") {
    if (slidesInfo.length) nextInfo(); else nextMedia();
  }
});

  // üî• Gestos de swipe (funciona p/ m√≠dia e infos)
let touchStartX = 0;
viewer.addEventListener("touchstart", (e) => {
  touchStartX = e.changedTouches[0].screenX;
});

viewer.addEventListener("touchend", (e) => {
  const touchEndX = e.changedTouches[0].screenX;
  if (touchEndX - touchStartX > 50) {
    if (slidesInfo.length) prevInfo(); else prevMedia();
  } else if (touchStartX - touchEndX > 50) {
    if (slidesInfo.length) nextInfo(); else nextMedia();
  }
});


function updateClasses() {
  slides.forEach((el, i) => {
    el.classList.remove("active");
    if (i === currentIndex) {
      el.classList.add("active");
      if (el.tagName === "VIDEO") el.play();
    } else {
      if (el.tagName === "VIDEO") {
        el.pause();
        el.currentTime = 0;
      }
    }
  });
}

function prevMedia() {
  currentIndex = (currentIndex - 1 + slides.length) % slides.length;
  updateClasses();
}

function nextMedia() {
  currentIndex = (currentIndex + 1) % slides.length;
  updateClasses();
}

// Fun√ß√£o para remover m√≠dia
 async function removerMidia(projNum, mediaUrl) {
  const ref = db.collection('projetos').doc('projeto' + projNum);

  await db.runTransaction(async (transaction) => {
    const doc = await transaction.get(ref);
    if (!doc.exists) return;

    const medias = doc.data().medias || [];
    const updatedMedias = medias.filter(media => media.url !== mediaUrl);

    transaction.update(ref, { medias: updatedMedias });
  });

  alert('M√≠dia removida com sucesso!');
  carregarProjetos();
}

  // ‚úÖ Fun√ß√£o para remover foto de perfil
async function removerFotoPerfil(projNum) {
  const ref = db.collection(getCollectionName()).doc('projeto' + projNum);
  await ref.update({ fotoPerfil: "" });
  alert("Foto de perfil removida com sucesso!");
  carregarProjetos();
}

  async function removerSom(projNum) {
  const ref = db.collection(getCollectionName()).doc('projeto' + projNum);
  await ref.update({ som: "" });
  alert("Som de fundo removido com sucesso!");
  carregarProjetos();
}


// Fun√ß√£o para criar o formul√°rio de edi√ß√£o
   function criarFormularioEdicao(projNum, data) {
  const form = document.createElement('div');
  form.className = 'edit-panel';

  // Se n√£o existir infos, define padr√£o
  const infos = data.infos && data.infos.length > 0 ? data.infos : [
  { chave: "Grupo", valor: "" },
  { chave: "Classe", valor: "" },
  { chave: "Resumo", valor: "" },
  { chave: "Intencao", valor: "" },
  { chave: "Finalidade", valor: "" }
];

  form.innerHTML = `
    <label>T√≠tulo: <input type="text" id="titulo-${projNum}" value="${data.titulo || ''}" maxlength="100"></label>
    <div id="infos-${projNum}"></div>
    <button type="button" onclick="adicionarInfo(${projNum})">+ Adicionar Info</button>
    <label>Adicionar M√≠dias: <input type="file" id="file-${projNum}" multiple>
    <label>Foto de Perfil: <input type="file" id="fotoPerfil-${projNum}" accept="image/*,image/gif"></label>
   <label>Cor de Fundo: <input type="text" id="cor-fundo-${projNum}" value="${data.ambientacao?.fundo || ''}" placeholder="Ex: #188392 ou Green"></label>
   <label>Cor Container Prim√°rio: <input type="text" id="cor-primary-${projNum}" value="${data.ambientacao?.containerPrimary || ''}" placeholder="Ex: Blue"></label>    
   <label>Cor Container Infos: <input type="text" id="cor-secondary-${projNum}" value="${data.ambientacao?.containerSecondary || ''}" placeholder="Ex: gray"></label>
   <label>Cor do T√≠tulo: <input type="text" id="cor-titulo-${projNum}" value="${data.ambientacao?.titulo || ''}" placeholder="Ex: White"></label>
   <label>Cor do Texto das Infos (chaves): <input type="text" id="cor-info-chave-${projNum}" value="${data.ambientacao?.infoChave || ''}" placeholder="Ex: Blue"></label>
   <label>Cor do Texto dos Valores: <input type="text" id="cor-info-valor-${projNum}" value="${data.ambientacao?.infoValor || ''}" placeholder="Ex: Black"></label>
   <label>Som de Fundo: 
   <input type="file" id="som-${projNum}" accept="audio/*">
   </label>
   <div id="som-lista-${projNum}"></div>
   <button onclick="salvarTudo(${projNum})">Salvar Tudo</button>
   <button onclick="cancelarEdicao(${projNum})" class="cancel-btn">Cancelar</button>
   <button type="button" onclick="resetProjeto(${projNum})"
        style="background:#ff6666;color:#fff;margin-top:10px;">
  Resetar Projeto
</button>
  `;

  const somLista = form.querySelector(`#som-lista-${projNum}`);
if (data.som) {
  const audioDiv = document.createElement("div");
  audioDiv.className = "audio-item";
  audioDiv.innerHTML = `
    ${decodeURIComponent(data.som.split("/").pop())}
    <button class="remove-media-btn" onclick="removerSom(${projNum})">Remover</button>
  `;
  somLista.appendChild(audioDiv);
}


  const infosDiv = form.querySelector(`#infos-${projNum}`);
infos.forEach((info, idx) => {
  const linha = document.createElement("div");
  linha.className = "info-line"; // üî• classe p/ arrastar
  linha.innerHTML = `
    <input type="text" id="info-chave-${projNum}-${idx}" value="${info.chave}" placeholder="Nome da info">
    <input type="text" id="info-valor-${projNum}-${idx}" value="${info.valor}" placeholder="Valor">
    <button type="button" onclick="removerInfo(${projNum}, ${idx})">‚ùå</button>
  `;
  infosDiv.appendChild(linha);
});


  return form;
}

function adicionarInfo(projNum) {
  const infosDiv = document.getElementById(`infos-${projNum}`);
  const idx = infosDiv.children.length;
  const linha = document.createElement("div");
  linha.innerHTML = `
  <input type="text" id="info-chave-${projNum}-${idx}" placeholder="Nome da info">
  <input type="text" id="info-valor-${projNum}-${idx}" placeholder="Valor">
  <button type="button" onclick="removerInfo(${projNum}, ${idx})">‚ùå</button>
   ` ;

  infosDiv.appendChild(linha);
}

function removerInfo(projNum, idx) {
  const linha = document.getElementById(`info-chave-${projNum}-${idx}`)?.parentNode;
  if (linha) linha.remove();
}

// Fun√ß√£o de valida√ß√£o em tempo real (apenas limite m√°ximo)
function validarCampo(projNum, campo, maxLength) {
  const input = document.getElementById(`${campo}-${projNum}`);
  const erroSpan = document.getElementById(`erro-${campo}-${projNum}`);
  const valor = input.value.trim();
  
  if (valor.length > maxLength) {
    erroSpan.innerText = `M√°ximo de ${maxLength} caracteres.`;
    return false;
  } else {
    erroSpan.innerText = '';
    return true;
  }
}

// Fun√ß√£o para cancelar edi√ß√£o
function cancelarEdicao(projNum) {
  carregarProjetos();
}

  // ‚úÖ L√≥gica do bot√£o de troca A/B
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggleClassBtn");
  if (toggleBtn) {
    toggleBtn.onclick = () => {
      currentClass = currentClass === "A" ? "B" : "A";
      toggleBtn.innerText = "Classe " + currentClass;
      carregarProjetos();
    };
  }
});

  // Fun√ß√£o para alternar modo tela cheia
function toggleFullscreen(projNum) {
  const project = document.getElementById('projeto' + projNum);

  if (project.classList.contains('fullscreen')) {
    // üîô Saindo do fullscreen
    project.classList.remove('fullscreen');
    project.querySelector('.fullscreen-btn').innerText = 'Expandir';
    document.body.style.overflow = 'auto';

    // üéµ Para o som ao sair do fullscreen
    document.querySelectorAll("audio.bg-audio").forEach(a => a.remove());

  } else {
    // ‚¨Ü Entrando em fullscreen
    document.querySelectorAll('.project').forEach(p => p.classList.remove('fullscreen'));
    project.classList.add('fullscreen');
    project.querySelector('.fullscreen-btn').innerText = 'Minimizar';
    document.body.style.overflow = 'hidden';

    // üéµ Som de fundo
    const ref = db.collection(getCollectionName()).doc('projeto' + projNum);
    ref.get().then(doc => {
      if (doc.exists && doc.data().som) {
        const audioUrl = doc.data().som;

        // Remove sons anteriores antes de tocar outro
        document.querySelectorAll("audio.bg-audio").forEach(a => a.remove());

        const audio = document.createElement("audio");
        audio.src = audioUrl;
        audio.loop = true;
        audio.autoplay = true;
        audio.volume = 0.3; // üîâ volume baixo
        audio.className = "bg-audio";

        document.body.appendChild(audio);
      }
    });
  }
}

// Fun√ß√£o para carregar projetos
function carregarProjetos() {
  const container = document.getElementById('projectsContainer');
  container.innerHTML = `
  <div class="filtro">
    <input type="text" id="filtro-projetos" placeholder="Filtrar">

    <div class="linha-select">
      <select id="ordenar-projetos">
        <option value="numero">Ordenar por N√∫mero</option>
        <option value="grupo">Ordenar por Grupo</option>
        <option value="ultima-edicao">Ordenar por √öltima Edi√ß√£o</option>
      </select>

      <button id="toggleDeviceBtn" style="
        background: #222;
        color: #00ff00;
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 16px;
        cursor: pointer;">
        üì± / üíª
      </button>
    </div>
  </div>
`;

  const total = projectLimits[currentClass]; // usa limite da classe
for (let i = 1; i <= total; i++) {
  let projDiv = document.createElement('div');
  projDiv.id = 'projeto' + i;
  projDiv.className = 'project';
  projDiv.dataset.projetoNum = i;
  container.appendChild(projDiv);

  db.collection(getCollectionName()).doc('projeto' + i).onSnapshot(doc => {
  const data = doc.exists ? doc.data() : {};
  projDiv.innerHTML = `
     <h2>${data.titulo || "Projeto " + i}</h2>

     <div class="foto-perfil">
      ${data.fotoPerfil ? `
        <div class="media-container">
          <img src="${data.fotoPerfil}" class="foto-perfil-img" 
         onclick="abrirFotoPerfil('${data.fotoPerfil}')">
          ${isEditing && Number(currentProject) === i ? 
            `<button class="remove-media-btn" onclick="removerFotoPerfil(${i})">Remover</button>` 
            : ""}
        </div>` 
      : ""}
    </div>

    <button class="fullscreen-btn" onclick="toggleFullscreen(${i})">Expandir</button>
  
    <div class="info-top">
      <div class="info-block">
        ${(data.infos && data.infos.length > 0 
          ? data.infos 
          : [
              { chave: "Grupo", valor: data.grupo || "" },
              { chave: "Classe", valor: data.classe || "" },
              { chave: "Resumo", valor: data.resumo || "" },
              { chave: "Intencao", valor: data.intencao || "" },
              { chave: "Finalidade", valor: data.finalidade || "" }
            ]
        ).map(info => `
          <div class="info-item" onclick="abrirInfoTelaCheia('${info.chave}', '${info.valor}', ${i})">
            ${info.chave}: <span>${info.valor}</span>
          </div>
        `).join('')}
      </div>
    </div>

    <div id="media-${i}" class="sortable-media"></div>
    <div id="lock-${i}" class="editing-lock"></div>
  `;

  // üé® Aplica ambienta√ß√£o ao container e textos
if (data.ambientacao) {
  if (data.ambientacao.containerPrimary) projDiv.style.background = data.ambientacao.containerPrimary;
  if (data.ambientacao.titulo) {
    const tituloEl = projDiv.querySelector("h2");
    if (tituloEl) tituloEl.style.color = data.ambientacao.titulo;
  }

  projDiv.querySelectorAll(".info-item").forEach(el => {
    if (data.ambientacao.containerSecondary) el.style.background = data.ambientacao.containerSecondary;
    if (data.ambientacao.infoChave) el.style.color = data.ambientacao.infoChave;
    const span = el.querySelector("span");
    if (span && data.ambientacao.infoValor) span.style.color = data.ambientacao.infoValor;
  });

    const expandirBtn = projDiv.querySelector(".fullscreen-btn");
if (expandirBtn) {
  if (data.ambientacao.containerSecondary) {
    expandirBtn.style.background = data.ambientacao.containerSecondary;
  }
  if (data.ambientacao.infoChave) {
    expandirBtn.style.color = data.ambientacao.infoChave;
  }
}

  // üëá Novo: aplica fundo e header se este projeto estiver vis√≠vel
  const rect = projDiv.getBoundingClientRect();
  if (rect.top >= 0 && rect.bottom <= window.innerHeight) {
    if (data.ambientacao.fundo) document.body.style.background = data.ambientacao.fundo;
  }
}

  const mediaDiv = projDiv.querySelector(`#media-${i}`);
  mediaDiv.innerHTML = '';
  if (data.medias) {
    data.medias.forEach((m, index) => {
      const mediaContainer = document.createElement('div');
      mediaContainer.className = 'media-container';
      const el = document.createElement(m.tipo === 'video' ? 'video' : 'img');
      el.src = m.url;
      if (m.tipo === 'video') el.controls = true;
      el.className = 'media-item';
      el.onclick = (e) => {
        if (!isEditing || Number(currentProject) !== i) {
          abrirMediaTelaCheia(m.url, m.tipo, data.medias);
        }
      };
      mediaContainer.appendChild(el);

      if (isEditing && Number(currentProject) === i) {
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-media-btn';
        removeBtn.innerText = 'Remover';
        removeBtn.onclick = () => removerMidia(i, m.url);
        mediaContainer.appendChild(removeBtn);
      }

      mediaDiv.appendChild(mediaContainer);
    });
  }

  if (isEditing && Number(currentProject) === i) {
    projDiv.appendChild(criarFormularioEdicao(i, data));
    new Sortable(mediaDiv, { 
      animation: 150,
      onStart: (evt) => {
        mediaDiv.querySelectorAll('.media-item').forEach(el => el.onclick = null);
      },
      onEnd: (evt) => {
        mediaDiv.querySelectorAll('.media-item').forEach((el, idx) => {
          el.onclick = () => abrirMediaTelaCheia(data.medias[idx].url, data.medias[idx].tipo);
        });
      }
    });
  }
});


    db.collection('locks').doc('projeto' + i).onSnapshot(lockDoc => {
      const lockInfo = document.getElementById('lock-' + i);
      if (lockDoc.exists && lockDoc.data().locked && !(isEditing && Number(currentProject) === i)) {
  const nome = lockDoc.data().userNome || "Algu√©m";
  const papel = lockDoc.data().isLider ? "l√≠der" : "membro";
  lockInfo.innerText = `${nome} (${papel}) est√° editando este projeto.`;
}  else {
        lockInfo.innerText = '';
      }
    });
  }

  configurarFiltroEOrdenacao();

// üîÑ Reaplica modo mobile se estava ativo
  const estavaAtivo = localStorage.getItem("mobileModeAtivo") === "1";
  if (estavaAtivo) {
    document.querySelectorAll(".project").forEach(el => el.classList.add("mobile-mode"));
  }
}



// Fun√ß√£o para configurar filtro e ordena√ß√£o
function configurarFiltroEOrdenacao() {
  document.getElementById('filtro-projetos').addEventListener('input', function() {
    const filtro = this.value.toLowerCase();
    document.querySelectorAll('.project').forEach(proj => {
      // procura dentro das infos
const blocos = Array.from(proj.querySelectorAll('.info-item span')).map(el => el.innerText.toLowerCase());
const grupo = blocos.find((_, idx) => proj.querySelectorAll('.info-item')[idx]?.innerText.startsWith("Grupo")) || "";
const classe = blocos.find((_, idx) => proj.querySelectorAll('.info-item')[idx]?.innerText.startsWith("Classe")) || "";
      const numero = proj.dataset.projetoNum;
      if (proj.classList.contains('fullscreen')) return;
      proj.style.display = (grupo.includes(filtro) || classe.includes(filtro) || numero.includes(filtro)) ? 'block' : 'none';
    });
  });

  document.getElementById('ordenar-projetos').addEventListener('change', function() {
    const criterio = this.value;
    const container = document.getElementById('projectsContainer');
    const projetos = Array.from(container.querySelectorAll('.project'));
    
    projetos.sort((a, b) => {
      if (criterio === 'numero') {
        return Number(a.dataset.projetoNum) - Number(b.dataset.projetoNum);
      } else if (criterio === 'grupo') {
        const grupoA = Array.from(a.querySelectorAll('.info-item')).find(el => el.innerText.startsWith("Grupo"))?.querySelector("span")?.innerText.toLowerCase() || "";
        const grupoB = Array.from(b.querySelectorAll('.info-item')).find(el => el.innerText.startsWith("Grupo"))?.querySelector("span")?.innerText.toLowerCase() || "";
        return grupoA.localeCompare(grupoB);
      } else if (criterio === 'ultima-edicao') {
        return 0; // Placeholder, implementar com Firestore se necess√°rio
      }
      return 0;
    });

    const filtroDiv = container.querySelector('.filtro');
    container.innerHTML = '';
    container.appendChild(filtroDiv);
    projetos.forEach(proj => container.appendChild(proj));
  });
}

   // Fun√ß√£o para salvar projetos
async function salvarTudo(projNum) {
  const titulo = document.getElementById(`titulo-${projNum}`).value.trim();
  const infosDiv = document.getElementById(`infos-${projNum}`);
  const infos = [];

  Array.from(infosDiv.children).forEach((linha, idx) => {
    const chave = document.getElementById(`info-chave-${projNum}-${idx}`)?.value.trim();
    const valor = document.getElementById(`info-valor-${projNum}-${idx}`)?.value.trim();
    if (chave) infos.push({ chave, valor });
  });

  const files = document.getElementById(`file-${projNum}`).files;

  let valido = true;
  infos.forEach((info, idx) => {
    if (info.chave.length > 50 || info.valor.length > 500) {
      alert(`"${info.chave}" ultrapassou limite de caracteres.`);
      valido = false;
    }
  });
  if (!valido) return;

  const ref = db.collection(getCollectionName()).doc('projeto' + projNum);
  const doc = await ref.get();
  let medias = doc.exists && doc.data().medias ? doc.data().medias : [];

  if (files.length + medias.length > 5) {
    document.getElementById(`erro-file-${projNum}`).innerText = 'Limite de 5 m√≠dias por projeto.';
    return;
  }

  for (let f of files) {
    const url = await uploadToImageKit(f);
    medias.push({ url, tipo: f.type.startsWith('video') ? 'video' : 'image' });
  }

  // ‚úÖ Upload da foto de perfil
  const fotoPerfilFile = document.getElementById(`fotoPerfil-${projNum}`)?.files[0];
  let fotoPerfilUrl = doc.exists && doc.data().fotoPerfil ? doc.data().fotoPerfil : "";

  if (fotoPerfilFile) {
    if (fotoPerfilFile.type.startsWith("image/") && !fotoPerfilFile.type.startsWith("video/")) {
      fotoPerfilUrl = await uploadToImageKit(fotoPerfilFile);
    } else {
      document.getElementById(`erro-fotoPerfil-${projNum}`).innerText = "Apenas imagens ou GIFs permitidos.";
      return;
    }
  }

   // ‚úÖ Upload do som de fundo
const somFile = document.getElementById(`som-${projNum}`)?.files[0];
let somUrl = doc.exists && doc.data().som ? doc.data().som : "";

if (somFile) {
  if (somFile.type.startsWith("audio/")) {
    somUrl = await uploadToImageKit(somFile);
  } else {
    alert("Apenas arquivos de √°udio s√£o permitidos.");
    return;
  }
}

  // üé® Novos campos de ambienta√ß√£o
const corFundo = document.getElementById(`cor-fundo-${projNum}`)?.value || "";
const corContainerPrimary = document.getElementById(`cor-primary-${projNum}`)?.value || "";
const corContainerSecondary = document.getElementById(`cor-secondary-${projNum}`)?.value || "";
const corTitulo = document.getElementById(`cor-titulo-${projNum}`)?.value || "";
const corInfoChave = document.getElementById(`cor-info-chave-${projNum}`)?.value || "";
const corInfoValor = document.getElementById(`cor-info-valor-${projNum}`)?.value || "";

await ref.set({
  titulo,
  infos,
  medias,
  fotoPerfil: fotoPerfilUrl,
  ultimaEdicao: firebase.firestore.FieldValue.serverTimestamp(),
  som: somUrl,
  ambientacao: {
    fundo: corFundo,
    containerPrimary: corContainerPrimary,
    containerSecondary: corContainerSecondary,
    titulo: corTitulo,
    infoChave: corInfoChave,
    infoValor: corInfoValor
  }
});
  alert('Informa√ß√µes e m√≠dias atualizadas!');
  carregarProjetos();
}

// L√≥gica do gatinho (mantida intacta)
(function() {
  const Cat = {
    nekoEl: null,
    nekoPosX: -16,
    nekoPosY: -16,
    mousePosX: 0,
    mousePosY: 0,
    frameCount: 0,
    idleTime: 0,
    idleAnimation: null,
    idleAnimationFrame: 0,
    nekoSpeed: 12,

    spriteSets: {
      idle: [[-3, -3]],
      alert: [[-7, -3]],
      scratchSelf: [[-5, 0], [-6, 0], [-7, 0]],
      scratchWallN: [[0, 0], [0, -1]],
      scratchWallS: [[-7, -1], [-6, -2]],
      scratchWallE: [[-2, -2], [-2, -3]],
      scratchWallW: [[-4, 0], [-4, -1]],
      tired: [[-3, -2]],
      sleeping: [[-2, 0], [-2, -1]],
      N: [[-1, -2], [-1, -3]],
      NE: [[0, -2], [0, -3]],
      E: [[-3, 0], [-3, -1]],
      SE: [[-5, -1], [-5, -2]],
      S: [[-6, -3], [-7, -2]],
      SW: [[-5, -3], [-6, -1]],
      W: [[-4, -2], [-4, -3]],
      NW: [[-1, 0], [-1, -1]],
    },

    init: function() {
      this.nekoEl = document.querySelector("#oneko");
      if (!this.nekoEl) {
        console.warn("Elemento #oneko n√£o encontrado!");
        return;
      }
      this.nekoEl.style.display = "block";
      this.nekoEl.style.left = `${this.nekoPosX - 16}px`;
      this.nekoEl.style.top = `${this.nekoPosY - 16}px`;

      document.addEventListener('mousemove', (event) => {
        this.mousePosX = event.clientX;
        this.mousePosY = event.clientY;
      });

      window.setInterval(() => this.frame(), 100);
    },

    setSprite: function(name, frame) {
      const sprite = this.spriteSets[name][frame % this.spriteSets[name].length];
      this.nekoEl.style.backgroundPosition = `${sprite[0] * 32}px ${sprite[1] * 32}px`;
    },

    idle: function() {
      this.idleTime += 1;

      if (this.idleTime > 10 && Math.floor(Math.random() * 200) === 0 && this.idleAnimation === null) {
        const availableIdleAnimations = ["sleeping", "scratchSelf"];
        this.idleAnimation = availableIdleAnimations[Math.floor(Math.random() * availableIdleAnimations.length)];
      }

      switch (this.idleAnimation) {
        case "sleeping":
          this.setSprite("tired", 0);
          if (++this.idleAnimationFrame > 192) this.idleAnimation = null;
          break;
        case "scratchSelf":
          this.setSprite(this.idleAnimation, this.idleAnimationFrame);
          if (++this.idleAnimationFrame > 9) this.idleAnimation = null;
          break;
        default:
          this.setSprite("idle", 0);
      }
    },

    frame: function() {
      if (!this.nekoEl) return;
      this.frameCount += 1;
      const targetX = Math.min(Math.max(0, this.mousePosX), window.innerWidth);
      const targetY = Math.min(Math.max(1, this.mousePosY - 32), window.innerHeight - 1);
      const diffX = this.nekoPosX - targetX;
      const diffY = this.nekoPosY - targetY;
      const distance = Math.sqrt(diffX ** 2 + diffY ** 2);

      if (distance < this.nekoSpeed || (distance < 48 && Math.abs(diffY) < 16)) {
        this.idle();
        return;
      }

      this.idleAnimation = null;
      this.idleAnimationFrame = 0;
      const direction = (diffY / distance > 0.5 ? "N" : "") + (diffY / distance < -0.5 ? "S" : "") +
        (diffX / distance > 0.5 ? "W" : "") + (diffX / distance < -0.5 ? "E" : "");
      this.setSprite(direction, this.frameCount);

      this.nekoPosX -= (diffX / distance) * this.nekoSpeed;
      this.nekoPosY -= (diffY / distance) * this.nekoSpeed;

      this.nekoPosX = Math.min(Math.max(16, this.nekoPosX), window.innerWidth - 16);
      this.nekoPosY = Math.min(Math.max(16, this.nekoPosY), window.innerHeight - 16);

      this.nekoEl.style.left = `${this.nekoPosX - 16}px`;
      this.nekoEl.style.top = `${this.nekoPosY - 16}px`;
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    try {
      Cat.init();
    } catch (e) {
      console.error("Erro ao inicializar o gato:", e);
    }
  });
})();

    // ‚úÖ Bot√£o para alternar layout Celular / Windows (salva estado)
document.addEventListener("DOMContentLoaded", () => {
  const toggleDeviceBtn = document.getElementById("toggleDeviceBtn");
  if (toggleDeviceBtn) {
    toggleDeviceBtn.addEventListener("click", () => {
      const projetos = document.querySelectorAll(".project");
      projetos.forEach(el => el.classList.toggle("mobile-mode"));

      // salva o estado no localStorage
      const ativo = projetos.length && projetos[0].classList.contains("mobile-mode");
      localStorage.setItem("mobileModeAtivo", ativo ? "1" : "0");
    });
  }
});

  // üé® Detecta scroll e aplica ambienta√ß√£o do projeto vis√≠vel
window.addEventListener("scroll", () => {
  let corAplicada = false;

  document.querySelectorAll(".project").forEach(proj => {
    const rect = proj.getBoundingClientRect();

    // ‚úÖ considera projeto parcialmente vis√≠vel
    if (rect.top < window.innerHeight && rect.bottom > 0) {
      const projNum = proj.dataset.projetoNum;
      db.collection(getCollectionName())
        .doc("projeto" + projNum)
        .get()
        .then(doc => {
          if (doc.exists && doc.data().ambientacao && doc.data().ambientacao.fundo) {
            const amb = doc.data().ambientacao;

            document.body.style.background = amb.fundo;
            if (amb.titulo) {
              const tituloEl = document.querySelector(`#projeto${projNum} h2`);
              if (tituloEl) tituloEl.style.color = amb.titulo;
            }

            corAplicada = true;
          }
        });
    }
  });

  // üîÑ Se nenhum projeto vis√≠vel tem cor definida, volta para o padr√£o do site
  setTimeout(() => {
    if (!corAplicada) {
      document.body.style.background = "";        // volta para o CSS padr√£o
    }
  }, 100);
});

   // üéµ M√∫sica de fundo autom√°tica ao rolar
let audioAtual = null;     // <audio> em uso
let projetoAtual = null;   // n√∫mero do projeto atual
let audioLiberado = false; // desbloqueio de autoplay

// ‚úÖ desbloqueia √°udio no primeiro clique
document.addEventListener("click", () => {
  if (!audioLiberado) {
    audioAtual = document.createElement("audio");
    audioAtual.loop = true;
    audioAtual.volume = 0.3;
    audioAtual.className = "bg-audio";
    document.body.appendChild(audioAtual);
    audioLiberado = true;
  }
});

window.addEventListener("scroll", () => {
  if (!audioLiberado) return;

  let projetoVisivel = null;

  document.querySelectorAll(".project").forEach(proj => {
    const rect = proj.getBoundingClientRect();
    if (rect.top < window.innerHeight && rect.bottom > 0) {
      projetoVisivel = proj.dataset.projetoNum;
    }
  });

  if (projetoVisivel && projetoVisivel !== projetoAtual) {
    // üîá pausa imediatamente se estava tocando outro
    if (audioAtual) {
      audioAtual.pause();
      audioAtual.currentTime = 0;
    }

    projetoAtual = projetoVisivel;

    // pega som do novo projeto
    db.collection(getCollectionName())
      .doc("projeto" + projetoAtual)
      .get()
      .then(doc => {
        if (doc.exists && doc.data().som && audioAtual) {
          audioAtual.src = doc.data().som;
          audioAtual.play().catch(err => console.warn("Autoplay bloqueado:", err));
        } else {
          // se n√£o tem som ‚Üí garantir que nada toque
          audioAtual.pause();
          audioAtual.currentTime = 0;
        }
      });
  }

  // se nenhum projeto vis√≠vel ‚Üí parar imediatamente
  if (!projetoVisivel && audioAtual) {
    audioAtual.pause();
    audioAtual.currentTime = 0;
    projetoAtual = null;
  }
});


 async function resetProjeto(projNum) {
  if (!confirm("Deseja realmente resetar todas as cores, fontes e infos deste projeto?")) return;

  const ref = db.collection(getCollectionName()).doc('projeto' + projNum);
  const doc = await ref.get();
  if (!doc.exists) return;

  const dados = doc.data();
  await ref.set({
    titulo: "",
    infos: [],
    medias: dados.medias || [],
    fotoPerfil: dados.fotoPerfil || "",
    ultimaEdicao: firebase.firestore.FieldValue.serverTimestamp(),
    ambientacao: {}
  });

  alert("Projeto resetado para o padr√£o!");
  carregarProjetos();
}

</script>
<footer style="text-align:center; margin-top:20px;">¬© 2025 Projetos Sustent√°veis</footer>
</body>
</html>
