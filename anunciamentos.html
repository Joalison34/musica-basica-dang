<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfJZVeKznju7J-KYTE-oSz6pRfbF6mBdQ",
  authDomain: "funzer.firebaseapp.com",
  projectId: "funzer",
  storageBucket: "funzer.firebasestorage.app",
  messagingSenderId: "723068647417",
  appId: "1:723068647417:web:7ae58205191b0099a1ef28"
};

const IMAGEKIT_PRIVATE_KEY = 'private_K0G6BijrJQ5r+PBaDTPnw1x7hLY='; // do Funzer
const IMAGEKIT_UPLOAD_URL = "https://upload.imagekit.io/api/v1/files/upload";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (currentUser?.role === "owner") {
  document.getElementById("formAnuncio").style.display = "block";
}

document.getElementById("postarBtn").addEventListener("click", async () => {
  const texto = document.getElementById("texto").value.trim();
  const arquivo = document.getElementById("arquivo").files[0];
  const status = document.getElementById("statusPostagem");

  if (!texto && !arquivo) {
    status.innerText = "Escreva algo ou selecione um arquivo.";
    return;
  }

  let imageUrl = "";
  let fileType = "";

  if (arquivo) {
    const formData = new FormData();
    formData.append("file", arquivo);
    formData.append("fileName", arquivo.name);

    try {
      const response = await fetch(IMAGEKIT_UPLOAD_URL, {
        method: "POST",
        headers: {
          Authorization: `Basic ${btoa(IMAGEKIT_PRIVATE_KEY + ':')}`
        },
        body: formData
      });

      const result = await response.json();
      if (result.url) {
        imageUrl = result.url;
        fileType = result.fileType;
      } else {
        status.innerText = "Erro ao obter URL da imagem.";
        console.error("Resposta do ImageKit:", result);
        return;
      }
    } catch (e) {
      status.innerText = "Erro ao enviar m√≠dia.";
      console.error("Erro ImageKit:", e);
      return;
    }
  }

  try {
    const docRef = await addDoc(collection(db, "post-anunci"), {
      text: texto,
      image: imageUrl || null,
      fileType: fileType || null,
      timestamp: Date.now(),
      username: currentUser?.username || "An√¥nimo"
    });
    status.innerText = "Postagem feita com sucesso!";
    document.getElementById("texto").value = "";
    document.getElementById("arquivo").value = "";
    carregarAnunciamentos();
  } catch (e) {
    status.innerText = "Erro ao salvar no banco.";
    console.error("Erro Firestore:", e);
  }
});

async function carregarAnunciamentos() {
  const container = document.getElementById("anuncios");
  container.innerHTML = "";

  try {
    const q = query(collection(db, "post-anunci"), orderBy("timestamp", "desc"));
    const snapshot = await getDocs(q);

    if (snapshot.empty) {
      container.innerHTML = "<p style='text-align:center;color:#444'>Nenhum anunciamento ainda.</p>";
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "post";

      let mediaHtml = "";
      if (data.image) {
        if (data.fileType === "video") {
          mediaHtml = `<video src="${data.image}" controls style="max-width:100%; margin-top:10px;"></video>`;
        } else {
          mediaHtml = `<img src="${data.image}" loading="lazy">`;
        }
      }

      let deleteButton = "";
      if (currentUser?.role === "owner" || currentUser?.username === data.username) {
        deleteButton = `<button onclick="deletarPost('${docSnap.id}')">üóëÔ∏è Apagar</button>`;
      }

      div.innerHTML = `
        <div class="meta">
          ${data.username || "An√¥nimo"} - ${new Date(data.timestamp).toLocaleString("pt-BR")}
          ${deleteButton}
        </div>
        <div>${data.text || ""}</div>
        ${mediaHtml}
      `;
      container.appendChild(div);
    });
  } catch (e) {
    console.error("Erro ao carregar anunciamentos:", e);
    container.innerHTML = "<p style='text-align:center;color:red'>Erro ao carregar anunciamentos.</p>";
  }
}

window.deletarPost = async function(id) {
  if (!confirm("Tem certeza que deseja apagar este post?")) return;

  try {
    await deleteDoc(doc(db, "post-anunci", id));
    alert("Post apagado.");
    carregarAnunciamentos();
  } catch (e) {
    console.error("Erro ao apagar:", e);
    alert("Erro ao apagar post.");
  }
};

carregarAnunciamentos();
</script>
