<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funzer</title>
    <link rel="icon" href="https://ik.imagekit.io/cdnau0gzt/ok.image.jpg?updatedAt=1746739159075" type="image/png" />
    <style>
        body {
    font-family: Verdana, Arial, sans-serif;
    background-color: #efebe7;
    color: #000;
    margin: 0;
    padding: 0;
    font-size: 13px;
    line-height: 1.4;
    width: 100%;
    min-height: 100vh;
    display: flex;
    justify-content: center;
}

.container {
    width: 100%;
    max-width: 100%; /* Remove o limite de 1200px pra ocupar todas a tela */
    margin: 0;
    background: #d9d2e9;
    padding: 5px; /* Reduz o padding pra economizar espa√ßo */
    border: none;
    box-sizing: border-box;
}
        h1 {
            font-size: 18px;
            text-align: center;
            margin: 10px 0;
            color: #800000;
        }
        .board-nav {
            text-align: center;
            margin-bottom: 10px;
        }
        .board-nav a {
            margin: 0 10px;
            color: #117743;
            text-decoration: none;
            font-weight: normal;
        }
        .board-nav a.active {
            font-weight: bold;
        }
        .board-nav a:hover {
            text-decoration: underline;
        }
        .form-section, .comment-section, .profile-section {
            margin-bottom: 10px;
        }
        input, textarea, button {
            font-family: Verdana, Arial, sans-serif;
            font-size: 13px;
            padding: 4px;
            margin: 2px 0;
            border: 1px solid #000;
            background: #fff;
            color: #000;
        }
        textarea {
            width: 100%;
            height: 100px;
            resize: vertical;
        }
        button {
            background: #b9c4e0;
            cursor: pointer;
            border: 1px solid #000;
        }
        button:hover {
            background: #a0a9c7;
        }
        .delete-btn, .view-posts-btn, .user-panel-btn, .feedback-btn, .rules-btn {
    background: #ff6666;
    color: #fff;
    padding: 2px 6px;
    border: 1px solid #000;
    cursor: pointer;
    font-size: 12px;
    margin-left: 5px;
}
.feedback-btn, .rules-btn {
    background: #ff8c00;
}
.feedback-btn:hover, .rules-btn:hover {
    background: #cc7000;
}
        .delete-btn:hover, .view-posts-btn:hover, .user-panel-btn:hover {
            background: #cc0000;
        }
        .feedback-btn:hover {
            background: #cc7000;
        }
        .ban-section {
            padding: 5px;
            border: 1px solid #000;
            background: #f0e0d6;
        }
        .post {
            border: 1px solid #000;
            padding: 10px;
            margin: 10px 0;
            background: #f0e0d6;
        }
        .post.op {
            background: #e0d6f0;
        }
        .post.reply {
            margin-left: 20px;
            background: #f0e0d6;
        }
        .post-header {
            font-size: 12px;
            color: #117743;
            margin-bottom: 5px;
        }
        .post-header .username {
            font-weight: bold;
            color: #117743;
        }
        .post-header .username.moderator {
            color: #0000ff;
            font-weight: bold;
        }
        .post-header .username.owner {
            color: #ff0000;
            font-weight: bold;
            background: #ffd700;
            padding: 2px 4px;
        }
        .post-content {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .post-media {
            flex-shrink: 0;
        }
        .post-text {
            flex-grow: 1;
            word-wrap: break-word;
        }
        .post img, .post video {
            max-width: 200px;
            max-height: 200px;
            margin: 0;
            border: 1px solid #000;
        }
       @media (max-width: 600px) {
    .container {
        padding: 5px;
    }
    .banner-image {
        height: 120px;
        width: 70%;
    }
    .post-content {
        display: block;
    }
    .post-media {
        margin-bottom: 5px;
    }
    .post img, .post video {
        max-width: 100%;
    }
    .catalog {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }
}
        .reply-link {
            color: #ff0000;
            cursor: pointer;
            text-decoration: none;
        }
        .reply-link:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #ff0000;
            font-size: 12px;
            text-align: center;
        }
        .profile-picture {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
        }
        .default-profile {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #ccc;
            color: #fff;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            vertical-align: middle;
            margin-right: 5px;
        }
        .bio {
            font-style: italic;
            color: #555;
            font-size: 11px;
            margin-bottom: 5px;
        }
        .view-toggle {
            margin: 10px 0;
            text-align: center;
        }
        .view-toggle button {
            margin: 0 5px;
        }
        .catalog {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 200px));
    gap: 10px;
    padding: 10px;
    box-sizing: border-box;
 }
        .catalog-item {
            border: 1px solid #000;
            background: #f0e0d6;
            padding: 5px;
            cursor: pointer;
            text-align: center;
        }
        .catalog-item:hover {
            background: #e0d6f0;
        }
        .catalog-item img, .catalog-item video {
            max-width: 100%;
            max-height: 100px;
            margin: 5px 0;
        }
        .catalog-item .catalog-text {
            font-size: 12px;
            color: #000;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        .catalog-item .catalog-meta {
            font-size: 10px;
            color: #555;
        }
        .post img.expandable, .post video.expandable {
    cursor: pointer;
    transition: all 0.3s ease;
}
.post img.expanded, .post video.expanded {
    max-width: 65vw;
    max-height: 65vh;
    width: auto;
    height: auto;
    z-index: 10;
    position: relative;
    display: block;
    margin: auto;
    object-fit: contain;
}
        
        .catalog-item img.expandable, .catalog-item video.expandable {
    cursor: pointer;
    transition: all 0.3s ease;
}
.catalog-item img.expanded, .catalog-item video.expanded {
    max-width: 100%;
    max-height: none;
    z-index: 10;
    position: relative;
    object-fit: contain;
}
        .modal, .feedback-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #d9d2e9;
            border: 1px solid #000;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 100;
        }
        .modal.active, .feedback-modal.active {
            display: block;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
        .modal-backdrop.active {
            display: block;
        }
        .modal-content, .feedback-modal-content {
            margin-bottom: 10px;
        }
        .modal-content h2, .feedback-modal-content h2 {
            font-size: 16px;
            margin: 0 0 10px;
            color: #800000;
        }
        .modal-content table, .feedback-modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .modal-content th, .modal-content td, .feedback-modal-content th, .feedback-modal-content td {
            border: 1px solid #000;
            padding: 5px;
            text-align: left;
            font-size: 12px;
        }
        .modal-content th, .feedback-modal-content th {
            background: #b9c4e0;
        }
        .modal-content tr:nth-child(even), .feedback-modal-content tr:nth-child(even) {
            background: #f0e0d6;
        }
        .modal-content tr:nth-child(odd), .feedback-modal-content tr:nth-child(odd) {
            background: #fff;
        }
        .modal-content .ban-btn, .feedback-modal-content .action-btn {
            background: #ff6666;
            color: #fff;
            padding: 2px 6px;
            border: 1px solid #000;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .modal-content .ban-btn:hover, .feedback-modal-content .action-btn:hover {
            background: #cc0000;
        }
        .modal-content .user-posts {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #000;
            background: #fff;
        }
        .feedback-modal-content textarea {
            height: 60px;
            margin-bottom: 5px;
        }
        .feedback-modal-content .response-section {
            margin-top: 5px;
            padding: 5px;
            border: 1px solid #000;
            background: #fff;
        }
        .close-modal-btn {
            background: #b9c4e0;
            padding: 4px 8px;
            border: 1px solid #000;
            cursor: pointer;
            font-size: 12px;
        }
        .close-modal-btn:hover {
            background: #a0a9c7;
        }
    .close-modal-btn:hover {
    background: #a0a9c7;
}
  .banner {
    width: 100%;
    margin: 0;
    padding: 0;
    
    border: none;
    text-align: center;
}

/* ... outros estilos ... */

.close-modal-btn:hover {
    background: #a0a9c7;
}
.banner-image {
    width: 50%;
    height: 200px;
    object-fit: fill; /* Estica a imagem, podendo distorcer */
    display: block;
    margin: 0 auto; /* Centraliza horizontalmente */
    border: none;
}  @media (max-width: 600px) {
    .banner-image {
        height: 120px; /* Reduz a altura em telas menores para melhor propor√ß√£o */
        width: 70%;    
    }
}                                                                                                                                      
    </style>
</head>
<body>
    <div class="container">
        <h1>Overboard - /üè†/ - Joalison</h1>
<div class="banner">
    <img src="https://ik.imagekit.io/cdnau0gzt/1000010399.jpg?updatedAt=1746641201704" alt="Banner de agradecimento" class="banner-image">
</div>
        <div class="board-nav">
            <a href="Funzer.html" class="active">[ Overboard ]</a>
            <a href="animes.html">[ /a/ ]</a>
            <a href="games.html">[ /g/ ]</a>
            <a href="random.html">[ /b/ ]</a>
            <a href="Hentai.html">[ /h/ ]</a>
        </div>

        <div id="createAccountSection" class="form-section">
            <input type="text" id="createUsername" placeholder="Username">
            <input type="password" id="createPassword" placeholder="Password">
            <input type="text" id="createBio" placeholder="Bio (max 150 chars)">
            <input type="file" id="createProfilePicture" accept="image/jpeg,image/png">
            <input type="text" id="roleCode" placeholder="Role code (optional)">
            <button id="createAccountBtn">Create Account</button>
            <p class="error" id="createErrorMessage"></p>
        </div>

        <div id="loginSection" class="form-section">
    <input type="text" id="loginUsername" placeholder="Username">
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p class="error" id="loginErrorMessage"></p>
</div>

<button id="loginAnonBtn">LOGAR COMO ANONIMATO</button>
<button id="logoutBtn" style="display: none;">Logout</button>

<script>
    document.getElementById('loginAnonBtn').addEventListener('click', function() {
        // Define as credenciais
        const username = "anonimato";
        const password = "773377";
        
        // Preenche os campos
        document.getElementById('loginUsername').value = username;
        document.getElementById('loginPassword').value = password;

        // Simula o clique no bot√£o de login
        document.getElementById('loginBtn').click();

        // Esconde o bot√£o de login an√¥nimo e mostra o bot√£o de logout
        document.getElementById('loginAnonBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'block';
    });

    document.getElementById('loginBtn').addEventListener('click', function() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        // Exemplo de valida√ß√£o (adicione sua l√≥gica real aqui)
        if (username === "anonimato" && password === "773377") {
            // Altera a interface ap√≥s o login
            document.getElementById('loginErrorMessage').innerText = "";
            // Adicione aqui a l√≥gica para o que acontece ap√≥s o login bem-sucedido
        } else {
            document.getElementById('loginErrorMessage').innerText = "Usu√°rio ou senha inv√°lidos!";
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', function() {
        // Limpa os campos de login
        document.getElementById('loginUsername').value = "";
        document.getElementById('loginPassword').value = "";

        // Esconde o bot√£o de logout e mostra o bot√£o de login an√¥nimo
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('loginAnonBtn').style.display = 'block';
    });
</script>

            
            
        <div id="profileSection" class="profile-section hidden">
            <p>Logged in as: <span id="currentUser"></span></p>
            <input type="text" id="editBio" placeholder="Update bio (max 150 chars)">
            <input type="file" id="editProfilePicture" accept="image/jpeg,image/png">
            <button id="updateProfileBtn">Update Profile</button>
            <p class="error" id="profileErrorMessage"></p>
        </div>

        <div id="commentSection" class="comment-section hidden">
            <button id="logoutBtn">Logout</button>
            <button id="userPanelBtn" class="user-panel-btn hidden">Painel Users</button>
            <button id="feedbackBtn" class="feedback-btn hidden">Feedback</button>
            <button id="rulesBtn" class="rules-btn hidden" onclick="window.location.href='rules.html'">Regras</button>
            <button onclick="mostrarAtualizacoes()">Atualiza√ß√µes</button>
            <textarea id="commentInput" placeholder="Comment"></textarea>
            <input type="file" id="mediaInput" accept="image/jpeg,image/png,image/gif,video/mp4,video/webm">
            <input type="text" id="replyTo" placeholder="Reply to post ID (optional)">
            <button id="postCommentBtn">Post Comment</button>
            <div id="banSection" class="ban-section hidden">
                <input type="text" id="banUsername" placeholder="Username to ban">
                <button id="banUserBtn">Ban User</button>
            </div>
            <div class="view-toggle">
                <button id="indexViewBtn">Index View</button>
                <button id="catalogViewBtn">Catalog View</button>
            </div>
            <div id="postsList"></div>
            <div id="catalogList" class="catalog hidden"></div>
        </div>

        <div id="userPanelModal" class="modal">
            <div class="modal-content">
                <h2>User Management</h2>
                <p>Total Users: <span id="totalUsers">0</span> | Total Posts: <span id="totalPosts">0</span></p>
                <table id="userTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Post Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="close-modal-btn" id="closeUserPanelBtn">Close</button>
        </div>

        <div id="feedbackModal" class="feedback-modal">
            <div class="feedback-modal-content">
                <h2>Feedback</h2>
                <div id="feedbackForm" class="hidden">
                    <textarea id="feedbackInput" placeholder="Digite sua sugest√£o (m√°x. 500 caracteres)"></textarea>
                    <button id="submitFeedbackBtn">Enviar Feedback</button>
                    <p class="error" id="feedbackErrorMessage"></p>
                </div>
                <div id="feedbackAdmin">
                    <p>Total Feedbacks: <span id="totalFeedbacks">0</span> | Pendentes: <span id="pendingFeedbacks">0</span></p>
                    <table id="feedbackTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Mensagem</th>
                                <th>Resposta</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <button class="close-modal-btn" id="closeFeedbackBtn">Close</button>
        </div>
        <div id="modalBackdrop" class="modal-backdrop"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, writeBatch, setDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfJZVeKznju7J-KYTE-oSz6pRfbF6mBdQ",
            authDomain: "funzer.firebaseapp.com",
            projectId: "funzer",
            storageBucket: "funzer.firebasestorage.app",
            messagingSenderId: "723068647417",
            appId: "1:723068647417:web:7ae58205191b0099a1ef28"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            displayError('createErrorMessage', 'Server connection failed.');
            displayError('loginErrorMessage', 'Server connection failed.');
            displayError('profileErrorMessage', 'Server connection failed.');
            displayError('feedbackErrorMessage', 'Server connection failed.');
        }

        const IMAGEKIT_ID = 'lksjdf7sd'; // Substitua por seu ImageKit ID
        const IMAGEKIT_PRIVATE_KEY = 'private_K0G6BijrJQ5r+PBaDTPnw1x7hLY='; // Substitua por sua Private API Key
        const IMAGEKIT_UPLOAD_URL = `https://upload.imagekit.io/api/v1/files/upload`;
        const currentBoard = 'funzer';
            
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let currentView = 'index';
        let currentThreadId = null;

        // Event Listeners
        document.getElementById('createAccountBtn').addEventListener('click', createAccount);
        document.getElementById('loginBtn').addEventListener('click', login);
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('postCommentBtn').addEventListener('click', postComment);
        document.getElementById('banUserBtn').addEventListener('click', () => deleteUser(document.getElementById('banUsername').value.trim()));
        document.getElementById('updateProfileBtn').addEventListener('click', updateProfile);
        document.getElementById('indexViewBtn').addEventListener('click', () => switchView('index'));
        document.getElementById('catalogViewBtn').addEventListener('click', () => switchView('catalog'));
        document.getElementById('userPanelBtn').addEventListener('click', openUserPanelModal);
        document.getElementById('closeUserPanelBtn').addEventListener('click', closeUserPanelModal);
        document.getElementById('feedbackBtn').addEventListener('click', openFeedbackModal);
        document.getElementById('closeFeedbackBtn').addEventListener('click', closeFeedbackModal);
        document.getElementById('modalBackdrop').addEventListener('click', closeAllModals);
        document.getElementById('submitFeedbackBtn').addEventListener('click', submitFeedback);
        document.getElementById('feedbackModal').addEventListener('click', handleFeedbackPanelClick);

        document.getElementById('postsList').addEventListener('click', (event) => {
            toggleImageExpansion(event);
            handlePostClick(event);
        });
        document.getElementById('catalogList').addEventListener('click', (event) => {
            toggleImageExpansion(event);
            handleCatalogClick(event);
        });
        document.getElementById('userPanelModal').addEventListener('click', handleUserPanelClick);

        function displayError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) element.textContent = message;
        }

        function openUserPanelModal() {
            document.getElementById('userPanelModal').classList.add('active');
            document.getElementById('modalBackdrop').classList.add('active');
            loadUserPanel();
        }

        function closeUserPanelModal() {
            document.getElementById('userPanelModal').classList.remove('active');
            document.getElementById('modalBackdrop').classList.remove('active');
            document.querySelector('#userTable tbody').innerHTML = '';
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('active');
            document.getElementById('modalBackdrop').classList.add('active');
            loadFeedbackPanel();
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            document.getElementById('modalBackdrop').classList.remove('active');
            document.querySelector('#feedbackTable tbody').innerHTML = '';
            document.getElementById('feedbackInput').value = '';
            displayError('feedbackErrorMessage', '');
        }

        function closeAllModals() {
            closeUserPanelModal();
            closeFeedbackModal();
        }

        function handlePostClick(event) {
    if (event.target.classList.contains('delete-btn')) {
        const commentId = event.target.getAttribute('data-comment-id');
        deleteComment(commentId);
    } else if (event.target.classList.contains('reply-link')) {
        const postId = event.target.getAttribute('data-post-id');
        // Buscar o post no Firestore para obter a board
        getDocs(query(collection(db, 'posts'), where('postId', '==', postId))).then(postSnapshot => {
            if (!postSnapshot.empty) {
                const postData = postSnapshot.docs[0].data();
                const board = postData.board;
                const boardUrl = getBoardUrl(board);
                // Redirecionar para a board correta com o postId
                window.location.href = `${boardUrl}#${postId}`;
            } else {
                // Fallback: preencher o campo replyTo localmente
                document.getElementById('replyTo').value = postId;
                document.getElementById('commentInput').focus();
            }
        }).catch(error => {
            console.error("Error fetching post for reply:", error);
            // Fallback: preencher o campo replyTo localmente
            document.getElementById('replyTo').value = postId;
            document.getElementById('commentInput').focus();
        });
    }
}

        function handleCatalogClick(event) {
            const catalogItem = event.target.closest('.catalog-item');
            if (catalogItem) {
                const postId = catalogItem.getAttribute('data-post-id');
                loadThread(postId);
            }
        }

        function handleUserPanelClick(event) {
            if (event.target.classList.contains('view-posts-btn')) {
                const username = event.target.getAttribute('data-username');
                toggleUserPosts(username);
            } else if (event.target.classList.contains('ban-btn')) {
                const username = event.target.getAttribute('data-username');
                deleteUser(username);
            } else if (event.target.classList.contains('delete-post-btn')) {
                const commentId = event.target.getAttribute('data-comment-id');
                deleteComment(commentId);
            }
        }

        function handleFeedbackPanelClick(event) {
            if (event.target.classList.contains('respond-btn')) {
                const feedbackId = event.target.getAttribute('data-feedback-id');
                toggleResponseSection(feedbackId);
            } else if (event.target.classList.contains('submit-response-btn')) {
                const feedbackId = event.target.getAttribute('data-feedback-id');
                const responseInput = document.getElementById(`response-input-${feedbackId}`);
                respondFeedback(feedbackId, responseInput.value.trim());
            } else if (event.target.classList.contains('delete-feedback-btn')) {
                const feedbackId = event.target.getAttribute('data-feedback-id');
                deleteFeedback(feedbackId);
            }
        }

        async function hashPassword(password) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hash = await crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error("Error hashing password:", error);
                throw new Error('Password processing failed.');
            }
        }

        function validateUsername(username) {
            const regex = /^[a-zA-Z0-9_]{3,20}$/;
            return regex.test(username);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        function validateBio(bio) {
            return bio.length <= 150;
        }

        function validateFeedback(message) {
            return message.length > 0 && message.length <= 500;
        }

        function updateUIForLoggedInUser() {
            document.getElementById('createAccountSection').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('commentSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
            document.getElementById('currentUser').innerHTML = `<span class="username ${currentUser.role}">${currentUser.username}</span> ${currentUser.role !== 'common' ? '(' + currentUser.role + ')' : ''}`;
            document.getElementById('banSection').classList.toggle('hidden', currentUser.role !== 'owner');
            document.getElementById('userPanelBtn').classList.toggle('hidden', !['moderator', 'owner'].includes(currentUser.role));
            document.getElementById('feedbackBtn').classList.remove('hidden');
            document.getElementById('rulesBtn').classList.remove('hidden');
            document.getElementById('editBio').value = currentUser.bio || '';
            loadPosts();
        }

        async function uploadToImageKit(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('fileName', file.name);
    try {
        const response = await fetch(IMAGEKIT_UPLOAD_URL, {
            method: 'POST',
            headers: {
                Authorization: `Basic ${btoa(IMAGEKIT_PRIVATE_KEY + ':')}`
            },
            body: formData
        });
        const result = await response.json();
        if (result.error) {
            throw new Error(result.error.message);
        }
        return {
            url: result.url,
            type: result.fileType === 'image' ? 'image' : 'video'
        };
    } catch (error) {
        console.error("Error uploading to ImageKit:", error);
        throw new Error('Media upload failed.');
    }
}

        async function createAccount() {
            console.log("createAccount called");
            const username = document.getElementById('createUsername')?.value.trim();
            const password = document.getElementById('createPassword')?.value.trim();
            const bio = document.getElementById('createBio')?.value.trim();
            const profilePicture = document.getElementById('createProfilePicture')?.files[0];
            const roleCode = document.getElementById('roleCode')?.value.trim().toUpperCase();
            const createErrorMessage = document.getElementById('createErrorMessage');

            if (!username || !password) {
                displayError('createErrorMessage', 'Username and password are required.');
                return;
            }

            if (!validateUsername(username)) {
                displayError('createErrorMessage', 'Username must be 3-20 alphanumeric chars or underscore.');
                return;
            }
            if (!validatePassword(password)) {
                displayError('createErrorMessage', 'Password must be at least 6 characters.');
                return;
            }
            if (bio && !validateBio(bio)) {
                displayError('createErrorMessage', 'Bio must be max 150 characters.');
                return;
            }
            if (profilePicture) {
                const allowedTypes = ['image/jpeg', 'image/gif', 'image/png'];
                if (!allowedTypes.includes(profilePicture.type)) {
                    displayError('createErrorMessage', 'Only JPEG or PNG images allowed.');
                    return;
                }
                const fileSizeLimit = 5 * 1024 * 1024;
                if (profilePicture.size > fileSizeLimit) {
                    displayError('createErrorMessage', 'Profile picture must be max 5 MB.');
                    return;
                }
            }
            if (!db) {
                displayError('createErrorMessage', 'Server not initialized.');
                return;
            }

            try {
                const userQuery = query(collection(db, 'users'), where('username', '==', username));
                const userSnapshot = await getDocs(userQuery);
                if (!userSnapshot.empty) {
                    displayError('createErrorMessage', 'Username already taken.');
                    return;
                }

                const hashedPassword = await hashPassword(password);
                const role = roleCode === '7733' ? 'moderator' : roleCode === 'ABACATE' ? 'owner' : 'common';
                let profilePictureURL = null;
                if (profilePicture) {
                    const uploadResult = await uploadToImageKit(profilePicture);
                    profilePictureURL = uploadResult.url;
                }
                const userData = {
                    username,
                    password: hashedPassword,
                    role,
                    bio: bio || '',
                    profilePictureURL: profilePictureURL || null
                };
                await setDoc(doc(db, 'users', username), userData);
                displayError('createErrorMessage', '');
                alert('Account created! Please login.');
                document.getElementById('createUsername').value = '';
                document.getElementById('createPassword').value = '';
                document.getElementById('createBio').value = '';
                document.getElementById('createProfilePicture').value = '';
                document.getElementById('roleCode').value = '';
            } catch (error) {
                console.error("Error creating account:", error);
                displayError('createErrorMessage', error.message || 'Failed to create account.');
            }
        }

        async function login() {
            console.log("login called");
            const username = document.getElementById('loginUsername')?.value.trim();
            const password = document.getElementById('loginPassword')?.value.trim();
            const loginErrorMessage = document.getElementById('loginErrorMessage');

            if (!username || !password) {
                displayError('loginErrorMessage', 'Username and password are required.');
                return;
            }

            if (!validateUsername(username)) {
                displayError('loginErrorMessage', 'Invalid username format.');
                return;
            }
            if (!validatePassword(password)) {
                displayError('loginErrorMessage', 'Password must be at least 6 characters.');
                return;
            }
            if (!db) {
                displayError('loginErrorMessage', 'Server not initialized.');
                return;
            }

            try {
                const userQuery = query(collection(db, 'users'), where('username', '==', username));
                const userSnapshot = await getDocs(userQuery);
                if (userSnapshot.empty) {
                    displayError('loginErrorMessage', 'Incorrect username or password.');
                    return;
                }
                const userDoc = userSnapshot.docs[0];
                const userData = userDoc.data();
                const hashedPassword = await hashPassword(password);
                if (userData.password !== hashedPassword) {
                    displayError('loginErrorMessage', 'Incorrect username or password.');
                    return;
                }
                currentUser = {
                    username: userData.username,
                    role: userData.role,
                    bio: userData.bio || '',
                    profilePictureURL: userData.profilePictureURL || null
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUIForLoggedInUser();
                displayError('loginErrorMessage', '');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            } catch (error) {
                console.error("Error logging in:", error);
                displayError('loginErrorMessage', error.message || 'Failed to login.');
            }
        }

        async function updateProfile() {
            if (!currentUser) {
                alert('Please login to update profile.');
                return;
            }
            const bio = document.getElementById('editBio')?.value.trim();
            const profilePicture = document.getElementById('editProfilePicture')?.files[0];
            const profileErrorMessage = document.getElementById('profileErrorMessage');

            if (bio && !validateBio(bio)) {
                displayError('profileErrorMessage', 'Bio must be max 150 characters.');
                return;
            }
            if (profilePicture) {
                const allowedTypes = ['image/jpeg', 'image/png'];
                if (!allowedTypes.includes(profilePicture.type)) {
                    displayError('profileErrorMessage', 'Only JPEG or PNG images allowed.');
                    return;
                }
                const fileSizeLimit = 5 * 1024 * 1024;
                if (profilePicture.size > fileSizeLimit) {
                    displayError('profileErrorMessage', 'Profile picture must be max 5 MB.');
                    return;
                }
            }
            if (!db) {
                displayError('profileErrorMessage', 'Server not initialized.');
                return;
            }

            try {
                let profilePictureURL = currentUser.profilePictureURL;
                if (profilePicture) {
                    const uploadResult = await uploadToImageKit(profilePicture);
                    profilePictureURL = uploadResult.url;
                }
                const userData = {
                    bio: bio || '',
                    profilePictureURL: profilePictureURL || null
                };
                await updateDoc(doc(db, 'users', currentUser.username), userData);
                currentUser.bio = bio || '';
                currentUser.profilePictureURL = profilePictureURL || null;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                displayError('profileErrorMessage', '');
                document.getElementById('editBio').value = bio;
                document.getElementById('editProfilePicture').value = '';
                alert('Profile updated successfully!');
                loadPosts();
                if (document.getElementById('userPanelModal').classList.contains('active')) {
                    loadUserPanel();
                }
            } catch (error) {
                console.error("Error updating profile:", error);
                displayError('profileErrorMessage', error.message || 'Failed to update profile.');
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('createAccountSection').classList.remove('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('commentSection').classList.add('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            document.getElementById('userPanelBtn').classList.add('hidden');
            document.getElementById('feedbackBtn').classList.add('hidden');
            document.getElementById('rulesBtn').classList.add('hidden');
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            closeAllModals();
            loadPosts();
        }

        async function postComment() {
    if (!currentUser) {
        alert('Login to comment.');
        return;
    }
    const commentText = document.getElementById('commentInput').value.trim();
    const mediaInput = document.getElementById('mediaInput').files[0];
    const replyTo = document.getElementById('replyTo').value.trim();
    if (!commentText && !mediaInput) {
        alert('Write a comment or select an image/video.');
        return;
    }
    if (!db) {
        alert('Error: Server not initialized.');
        return;
    }
    try {
        const today = new Date().toISOString().split('T')[0];
        let mediaURL = null;
        let mediaType = null;
        if (mediaInput) {
            const fileSizeLimit = 10 * 1024 * 1024;
            if (mediaInput.size > fileSizeLimit) {
                alert('File must be max 10 MB.');
                return;
            }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'video/mp4', 'video/webm'];
            if (!allowedTypes.includes(mediaInput.type)) {
                alert('Only JPEG, GIF, PNG images or MP4, WebM videos allowed.');
                return;
            }
            const uploadResult = await uploadToImageKit(mediaInput);
            mediaURL = uploadResult.url;
            mediaType = uploadResult.type;
        }
        const post = {
            username: currentUser.username,
            role: currentUser.role,
            text: commentText,
            timestamp: new Date().toISOString(),
            date: today,
            mediaURL: mediaURL || null,
            mediaType: mediaType || null,
            profilePictureURL: currentUser.profilePictureURL || null,
            bio: currentUser.bio || '',
            parentId: replyTo || null,
            postId: generatePostId(),
            board: currentBoard
        };
        console.log("Salvando post:", post);
        await addDoc(collection(db, 'posts'), post);
        document.getElementById('commentInput').value = '';
        document.getElementById('mediaInput').value = '';
        document.getElementById('replyTo').value = '';
        loadPosts();
    } catch (error) {
        console.error("Error posting comment:", error);
        alert('Error posting comment.');
    }
}
        function generatePostId() {
            return Math.floor(100000000 + Math.random() * 900000000).toString();
        }

        async function deleteComment(commentId) {
            if (!currentUser) {
                alert('Please login to delete posts.');
                return;
            }
            if (!db) {
                alert('Server not initialized.');
                return;
            }

            try {
                const commentDoc = doc(db, 'posts', commentId);
                const commentSnapshot = await getDocs(query(collection(db, 'posts'), where('__name__', '==', commentId)));
                if (commentSnapshot.empty) {
                    alert('Post not found.');
                    return;
                }
                const commentData = commentSnapshot.docs[0].data();
                if (currentUser.role === 'common' && commentData.username !== currentUser.username) {
                    alert('You can only delete your own posts.');
                    return;
                }
                await deleteDoc(commentDoc);
                loadPosts();
                if (document.getElementById('userPanelModal').classList.contains('active')) {
                    loadUserPanel();
                }
                alert('Post deleted successfully.');
            } catch (error) {
                console.error("Error deleting post:", error);
                alert(error.message || 'Failed to delete post.');
            }
        }

        async function deleteUser(username) {
            if (!currentUser || currentUser.role !== 'owner') {
                alert('Only the owner can ban users.');
                return;
            }
            if (!username) {
                alert('Please enter a username to ban.');
                return;
            }
            if (username === currentUser.username) {
                alert('You cannot ban yourself.');
                return;
            }
            if (!db) {
                alert('Server not initialized.');
                return;
            }

            try {
                const batch = writeBatch(db);
                const userDocRef = doc(db, 'users', username);
                const userSnapshot = await getDocs(query(collection(db, 'users'), where('username', '==', username)));
                if (userSnapshot.empty) {
                    alert('User not found.');
                    return;
                }
                batch.delete(userDocRef);
                const commentsQuery = query(collection(db, 'posts'), where('username', '==', username));
                const commentsSnapshot = await getDocs(commentsQuery);
                commentsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                document.getElementById('banUsername').value = '';
                alert(`User ${username} banned successfully.`);
                loadPosts();
                if (document.getElementById('userPanelModal').classList.contains('active')) {
                    loadUserPanel();
                }
            } catch (error) {
                console.error("Error banning user:", error);
                alert(error.message || 'Failed to ban user.');
            }
        }

        async function submitFeedback() {
            if (!currentUser) {
                alert('Please login to submit feedback.');
                return;
            }
            const feedbackText = document.getElementById('feedbackInput')?.value.trim();
            if (!validateFeedback(feedbackText)) {
                displayError('feedbackErrorMessage', 'Feedback must be 1-500 characters.');
                return;
            }
            if (!db) {
                displayError('feedbackErrorMessage', 'Server not initialized.');
                return;
            }

            try {
                const feedback = {
                    feedbackId: generatePostId(),
                    username: currentUser.username,
                    message: feedbackText,
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    response: null
                };
                await addDoc(collection(db, 'feedbacks'), feedback);
                document.getElementById('feedbackInput').value = '';
                displayError('feedbackErrorMessage', '');
                alert('Feedback submitted successfully!');
                loadFeedbackPanel();
            } catch (error) {
                console.error("Error submitting feedback:", error);
                displayError('feedbackErrorMessage', error.message || 'Failed to submit feedback.');
            }
        }

        async function loadFeedbackPanel() {
            if (!currentUser) {
                return;
            }
            const feedbackForm = document.getElementById('feedbackForm');
            const feedbackAdmin = document.getElementById('feedbackAdmin');
            const feedbackTableBody = document.querySelector('#feedbackTable tbody');
            const totalFeedbacksSpan = document.getElementById('totalFeedbacks');
            const pendingFeedbacksSpan = document.getElementById('pendingFeedbacks');
            feedbackTableBody.innerHTML = '';
            feedbackForm.classList.remove('hidden'); // Always show the feedback form for submitting new feedback
            feedbackAdmin.classList.remove('hidden'); // Always show the feedback table for all users

            if (!db) {
                feedbackTableBody.innerHTML = '<tr><td colspan="5" class="error">Server not initialized.</td></tr>';
                return;
            }

            try {
                const feedbacksSnapshot = await getDocs(query(collection(db, 'feedbacks'), orderBy('timestamp', 'desc')));
                let totalFeedbacks = 0;
                let pendingFeedbacks = 0;

                feedbacksSnapshot.forEach(doc => {
                    const feedback = doc.data();
                    totalFeedbacks++;
                    if (feedback.status === 'pending') pendingFeedbacks++;
                    const row = document.createElement('tr');
                    const truncatedMessage = feedback.message.length > 500 ? feedback.message.substring(0, 47) + '...' : feedback.message;
                    const truncatedResponse = feedback.response && feedback.response.length > 50 ? feedback.response.substring(0, 47) + '...' : feedback.response || 'Nenhuma';
                    const simplifiedStatus = feedback.status === 'pending' ? 'Pendente' : 'Respondido';
                    const actions = ['moderator', 'owner'].includes(currentUser.role) ? `
                        <button class="action-btn respond-btn" data-feedback-id="${doc.id}">Responder</button>
                        <button class="action-btn delete-feedback-btn" data-feedback-id="${doc.id}">Excluir</button>
                    ` : '';
                    row.innerHTML = `
                        <td>${feedback.username}</td>
                        <td>${truncatedMessage}</td>
                        <td>${truncatedResponse}</td>
                        <td>${simplifiedStatus}</td>
                        <td>${actions}</td>
                    `;
                    feedbackTableBody.appendChild(row);
                });

                totalFeedbacksSpan.textContent = totalFeedbacks;
                pendingFeedbacksSpan.textContent = pendingFeedbacks;
            } catch (error) {
                console.error("Error loading feedback panel:", error);
                feedbackTableBody.innerHTML = '<tr><td colspan="5" class="error">Unable to load feedbacks. Try again later.</td></tr>';
            }
        }

        function toggleResponseSection(feedbackId) {
            const row = document.querySelector(`#feedbackTable tr td button[data-feedback-id="${feedbackId}"]`).closest('tr');
            let responseDiv = row.nextElementSibling;
            if (responseDiv && responseDiv.classList.contains('response-section')) {
                responseDiv.remove();
                return;
            }

            responseDiv = document.createElement('div');
            responseDiv.className = 'response-section';
            responseDiv.innerHTML = `
                <textarea id="response-input-${feedbackId}" placeholder="Digite sua resposta (m√°x. 500 caracteres)"></textarea>
                <button class="action-btn submit-response-btn" data-feedback-id="${feedbackId}">Enviar Resposta</button>
            `;
            row.insertAdjacentElement('afterend', responseDiv);
        }

        async function respondFeedback(feedbackId, responseText) {
            if (!currentUser || !['moderator', 'owner'].includes(currentUser.role)) {
                alert('Only moderators or owner can respond to feedback.');
                return;
            }
            if (!validateFeedback(responseText)) {
                alert('Response must be 1-500 characters.');
                return;
            }
            if (!db) {
                alert('Server not initialized.');
                return;
            }

            try {
                const feedbackDoc = doc(db, 'feedbacks', feedbackId);
                await updateDoc(feedbackDoc, {
                    response: responseText,
                    status: 'responded'
                });
                alert('Response submitted successfully!');
                loadFeedbackPanel();
            } catch (error) {
                console.error("Error responding to feedback:", error);
                alert(error.message || 'Failed to submit response.');
            }
        }

        async function deleteFeedback(feedbackId) {
            if (!currentUser || !['moderator', 'owner'].includes(currentUser.role)) {
                alert('Only moderators or owner can delete feedback.');
                return;
            }
            if (!db) {
                alert('Server not initialized.');
                return;
            }

            try {
                const feedbackDoc = doc(db, 'feedbacks', feedbackId);
                await deleteDoc(feedbackDoc);
                alert('Feedback deleted successfully.');
                loadFeedbackPanel();
            } catch (error) {
                console.error("Error deleting feedback:", error);
                alert(error.message || 'Failed to delete feedback.');
            }
        }

        function switchView(view) {
            currentView = view;
            currentThreadId = null;
            document.getElementById('postsList').classList.toggle('hidden', view === 'catalog');
            document.getElementById('catalogList').classList.toggle('hidden', view === 'index');
            document.getElementById('indexViewBtn').style.background = view === 'index' ? '#a0a9c7' : '#b9c4e0';
            document.getElementById('catalogViewBtn').style.background = view === 'catalog' ? '#a0a9c7' : '#b9c4e0';
            loadPosts();
        }

        async function loadPosts() {
    const postsList = document.getElementById('postsList');
    const catalogList = document.getElementById('catalogList');
    postsList.innerHTML = '';
    catalogList.innerHTML = '';
    if (!db) {
        postsList.innerHTML = '<p class="error">Server not initialized.</p>';
        catalogList.innerHTML = '<p class="error">Server not initialized.</p>';
        return;
    }

    try {
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
        const initialQuery = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
        const postsSnapshot = await getDocs(initialQuery);
        let posts = [];

        postsSnapshot.forEach(doc => {
            const post = doc.data();
            const postDate = new Date(post.timestamp);
            if (postDate >= threeDaysAgo) {
                posts.push({ id: doc.id, data: post });
            }
        });

        if (posts.length === 0) {
            postsList.innerHTML = '<p class="error">No posts found. Try posting a new comment.</p>';
            catalogList.innerHTML = '<p class="error">No posts found. Try posting a new comment.</p>';
            return;
        }

        const buildCommentTree = (parentId = null) => {
            const children = posts.filter(post => post.data.parentId === parentId);
            return children.map(child => ({
                id: child.id,
                data: child.data,
                replies: buildCommentTree(child.data.postId)
            }));
        };

        const commentTree = buildCommentTree();

        const countReplies = (comment) => {
            let count = comment.replies.length;
            comment.replies.forEach(reply => {
                count += countReplies(reply);
            });
            return count;
        };

        const renderComment = (comment, depth, isOp = false) => {
            const div = document.createElement('div');
            div.className = `post ${isOp ? 'op' : 'reply'}`;
            if (!isOp) {
                div.style.marginLeft = `${20 * depth}px`;
            }
            const post = comment.data;
            const postId = comment.id;
            let deleteButton = '';
            if (currentUser) {
                if (currentUser.role === 'moderator' || currentUser.role === 'owner') {
                    deleteButton = `<button class="delete-btn" data-comment-id="${postId}">Delete</button>`;
                } else if (currentUser.role === 'common' && post.username === currentUser.username) {
                    deleteButton = `<button class="delete-btn" data-comment-id="${postId}">Delete</button>`;
                }
            }
            let mediaContent = '';
            if (post.mediaURL && post.mediaType) {
                if (post.mediaType === 'image') {
                    mediaContent = `<img src="${post.mediaURL}" alt="Image" class="expandable">`;
                } else if (post.mediaType === 'video') {
                    mediaContent = `<video controls src="${post.mediaURL}" alt="Video" class="expandable"></video>`;
                }
            }
            const profilePicture = post.profilePictureURL ?
                `.<img src="${post.profilePictureURL}" alt="Profile" class="profile-picture">` :
                `<span class="default-profile">${post.username[0].toUpperCase()}</span>`;
            const bioContent = post.bio ? `<div class="bio">${post.bio}</div>` : '';
            const roleLabel = post.role !== 'common' ? `(${post.role})` : '';
            const textContent = post.text || bioContent ? `
                <div class="post-text">
                    ${bioContent}
                    ${post.text}
                </div>
            ` : '';
            const mediaContainer = mediaContent ? `<div class="post-media">${mediaContent}</div>` : '';
            div.innerHTML = `
                <div class="post-header">
                    ${profilePicture}
                    <span class="username ${post.role}">${post.username}</span> ${roleLabel} 
                    No.${post.postId} ${new Date(post.timestamp).toLocaleString('pt-BR')}
                    [<a class="reply-link" data-post-id="${post.postId}">Reply</a>]
                    ${deleteButton}
                </div>
                <div class="post-content">
                    ${mediaContainer}
                    ${textContent}
                </div>
            `;
            postsList.appendChild(div);
            comment.replies.forEach(reply => renderComment(reply, depth + 1));
        };

        const renderCatalogItem = (comment) => {
            const div = document.createElement('div');
            div.className = 'catalog-item';
            div.setAttribute('data-post-id', comment.data.postId);
            const post = comment.data;
            const replyCount = countReplies(comment);
            let mediaContent = '';
            if (post.mediaURL && post.mediaType) {
                if (post.mediaType === 'image') {
                    mediaContent = `<img src="${post.mediaURL}" alt="Image" class="expandable">`;
                } else if (post.mediaType === 'video') {
                    mediaContent = `<video src="${post.mediaURL}" alt="Video" class="expandable"></video>`;
                }
            }
            const truncatedText = post.text.length > 100 ? post.text.substring(0, 97) + '...' : post.text;
            div.innerHTML = `
                ${mediaContent}
                <div class="catalog-text">${truncatedText || '[No text]'}</div>
                <div class="catalog-meta">${replyCount} replies, ${new Date(post.timestamp).toLocaleString('pt-BR')}</div>
            `;
            catalogList.appendChild(div);
        };

        if (currentView === 'catalog') {
            commentTree.forEach(thread => renderCatalogItem(thread));
        } else if (currentThreadId) {
            const thread = commentTree.find(t => t.data.postId === currentThreadId);
            if (thread) {
                renderComment(thread, 0, true);
            } else {
                postsList.innerHTML = '<p class="error">Thread not found.</p>';
            }
        } else {
            commentTree.forEach(thread => renderComment(thread, 0, true));
        }
    } catch (error) {
        console.error("Error loading posts:", error);
        postsList.innerHTML = '<p class="error">Unable to load posts. Try again later.</p>';
        catalogList.innerHTML = '<p class="error">Unable to load posts. Try again later.</p>';
    }
}

        async function loadUserPanel() {
            if (!currentUser || !['moderator', 'owner'].includes(currentUser.role)) {
                return;
            }
            const userTableBody = document.querySelector('#userTable tbody');
            const totalUsersSpan = document.getElementById('totalUsers');
            const totalPostsSpan = document.getElementById('totalPosts');
            userTableBody.innerHTML = '';
            if (!db) {
                userTableBody.innerHTML = '<tr><td colspan="4" class="error">Server not initialized.</td></tr>';
                return;
            }

            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const postsSnapshot = await getDocs(collection(db, 'posts'));
                let totalUsers = 0;
                let totalPosts = 0;
                const userPostCounts = {};

                postsSnapshot.forEach(doc => {
                    const post = doc.data();
                    userPostCounts[post.username] = (userPostCounts[post.username] || 0) + 1;
                    totalPosts++;
                });

                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    totalUsers++;
                    const postCount = userPostCounts[user.username] || 0;
                    const row = document.createElement('tr');
                    const banButton = currentUser.role === 'owner' && user.username !== currentUser.username ?
                        `<button class="ban-btn" data-username="${user.username}">Ban</button>` : '';
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${postCount}</td>
                        <td>
                            <button class="view-posts-btn" data-username="${user.username}">View Posts</button>
                            ${banButton}
                        </td>
                    `;
                    userTableBody.appendChild(row);
                });

                totalUsersSpan.textContent = totalUsers;
                totalPostsSpan.textContent = totalPosts;
            } catch (error) {
                console.error("Error loading user panel:", error);
                userTableBody.innerHTML = '<tr><td colspan="4" class="error">Unable to load users. Try again later.</td></tr>';
            }
        }

        async function toggleUserPosts(username) {
            const row = document.querySelector(`#userTable tr td button[data-username="${username}"]`).closest('tr');
            let postsDiv = row.nextElementSibling;
            
            if (postsDiv && postsDiv.classList.contains('user-posts')) {
                postsDiv.remove();
                return;
            }

            postsDiv = document.createElement('div');
            postsDiv.className = 'user-posts';
            row.insertAdjacentElement('afterend', postsDiv);

            try {
                const postsQuery = query(collection(db, 'posts'), where('username', '==', username));
                const postsSnapshot = await getDocs(postsQuery);
                if (postsSnapshot.empty) {
                    postsDiv.innerHTML = '<p>No posts found.</p>';
                    return;
                }
                postsSnapshot.forEach(doc => {
                    const post = doc.data();
                    const postDiv = document.createElement('div');
                    postDiv.style.border = '1px solid #000';
                    postDiv.style.margin = '5px 0';
                    postDiv.style.padding = '5px';
                    const truncatedText = post.text.length > 50 ? post.text.substring(0, 47) + '...' : post.text;
                    let mediaContent = '';
                    if (post.mediaURL && post.mediaType) {
                        if (post.mediaType === 'image') {
                            mediaContent = `<img src="${post.mediaURL}" alt="Image" style="max-width:50px; max-height:50px;">`;
                        } else if (post.mediaType === 'video') {
                            mediaContent = `<video src="${post.mediaURL}" alt="Video" style="max-width:50px; max-height:50px;"></video>`;
                        }
                    }
                    postDiv.innerHTML = `
                        <p><strong>Post ID:</strong> ${post.postId}</p>
                        <p><strong>Text:</strong> ${truncatedText || '[No text]'}</p>
                        ${mediaContent}
                        <p><strong>Date:</strong> ${new Date(post.timestamp).toLocaleString('pt-BR')}</p>
                        <button class="delete-post-btn" data-comment-id="${doc.id}">Delete</button>
                    `;
                    postsDiv.appendChild(postDiv);
                });
            } catch (error) {
                console.error("Error loading user posts:", error);
                postsDiv.innerHTML = '<p class="error">Unable to load posts.</p>';
            }
        }

        async function loadThread(postId) {
            currentThreadId = postId;
            currentView = 'index';
            document.getElementById('postsList').classList.remove('hidden');
            document.getElementById('catalogList').classList.add('hidden');
            document.getElementById('indexViewBtn').style.background = '#a0a9c7';
            document.getElementById('catalogViewBtn').style.background = '#b9c4e0';
            loadPosts();
        }

        function toggleImageExpansion(event) {
            const element = event.target;
            if (element.classList.contains('expandable')) {
                element.classList.toggle('expanded');
            }
        }

      function getBoardUrl(board) {
     const boardUrls = {
        'funzer': 'Funzer.html',
        'animes': 'animes.html',
        'games': 'games.html',
        'random': 'random.html',
        'Hentai': 'Hentai.html'
    };
    return boardUrls[board] || 'Funzer.html'; // Fallback para Funzer se a board n√£o for encontrada
}
    

        if (currentUser) {
            updateUIForLoggedInUser();
        } else {
            loadPosts();
        }

        <!-- Painel de Atualiza√ß√µes (inserido antes de </body>) -->
<div id="painelAtualizacoes" style="display:none; border:1px solid #ccc; padding:10px; margin:10px; background:#fff;">
  <h3>Atualiza√ß√µes</h3>
  <div id="conteudoAtualizacoes">
    <!-- As atualiza√ß√µes aparecer√£o aqui -->
  </div>
  <div id="editorAtualizacoes" style="margin-top:10px;">
    <textarea id="novaAtualizacao" placeholder="Digite a atualiza√ß√£o..." rows="3" style="width:100%;"></textarea>
    <button onclick="postarAtualizacao()">Postar</button>
  </div>
</div>

<script>
function mostrarAtualizacoes() {
  const painel = document.getElementById("painelAtualizacoes");
  painel.style.display = painel.style.display === "none" ? "block" : "none";
}

function postarAtualizacao() {
  const ehDono = currentUser?.role === 'owner'; // Verifica se √© dono

  if (!ehDono) {
    alert("Apenas o dono pode postar.");
    return;
  }

  const texto = document.getElementById("novaAtualizacao").value;
  if (texto.trim() === "") return;

  const div = document.createElement("div");
  div.innerHTML = `
    <p>${texto}</p>
    <button onclick="this.parentElement.remove()">Apagar</button>
    <hr>
  `;
  document.getElementById("conteudoAtualizacoes").prepend(div);
  document.getElementById("novaAtualizacao").value = "";
}
  </script><script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9399eb42fb69bf84',t:'MTc0NjIxNDA3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>

            
</script>


  </body>
</html>
